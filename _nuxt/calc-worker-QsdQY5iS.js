(function(){"use strict";const K=e=>e.reduce((t,o)=>t+o.normalCount+o.slideCount,0),ee=["kaho","sayaka","kozue","tsuzuri","rurino","megumi","ginko","kosuzu","hime","ceras","izumi","other"],m={kaho:"花帆",sayaka:"さやか",kozue:"梢",tsuzuri:"綴理",rurino:"瑠璃乃",megumi:"慈",ginko:"吟子",kosuzu:"小鈴",hime:"姫芽",ceras:"セラス",izumi:"泉",other:"その他"},te={all:ee,g102:["kozue","tsuzuri","megumi"],g103:["kaho","sayaka","rurino"],g104:["ginko","kosuzu","hime","izumi"],g105:["ceras"],cerise:["kaho","kozue","ginko"],dollche:["sayaka","tsuzuri","kosuzu"],miracra:["rurino","megumi","hime"],edel:["ceras","izumi"]},P=e=>e<=2100?Math.floor((-5+Math.sqrt(25+20*e))/10):Math.floor(20+(e-2100)/200),G=(e,t,o)=>(1+e/100)*(1+P(t)*(o?2:1)/10),q=e=>e<10?1:e<20?1.1:e<30?1.2:e<40?1.3:e<50?1.4:1.5,oe=({notes:e,convertedMembers:t,center:o,appealSum:p,mentalSum:s,masteryLevel:a,comboOffset:r})=>{const l=t.find(n=>n.name===o),i=l?.centerSkillCondition,u=l?.centerSkills||[],d=l?.centerAbilities||[],v=d.find(n=>n.type==="cooltime_reduce"),b=d.find(n=>n.type==="ap_reduce"),w=5-Number(v?.value[0]||0),k=Number(b?.value[1]||0),h=t.slice();let x=w,y=0,T=s,E=0,S=0;const L=[],U=[];let z=0,Q=0;const X=K(e);let A=0,Y=0;const j=new WeakMap,ue=60/(X-0);let V,f="";const B=(n,_)=>{const R=P(S),O=T*100/s;e:for(const c of _){if(c.condition){const[g,F,D]=c.condition;let C=0;switch(g){case"skill_count":C=j.get(n)||0;break;case"total_skill_count":C=Y;break;case"vol_lv":C=R;break;case"mental_rate":C=O;break;default:throw new Error(`条件式が不正です: ${g}`)}if(D===void 0)throw new Error(`条件式が不正です: ${g}`);switch(F){case"<=":if(!(C<=D))continue e;break;case">=":if(!(C>=D))continue e;break}}switch(c.type){case"vol_buff":U[0]=(U[0]||0)+(c.value||0),f+=`${m[n.name]} vol_buff: +${c.value}
`;break;case"vol_up":{const g=U.shift()||0;S+=(c.value||0)*(1+g/100),f+=`${m[n.name]} vol_up: +${(c.value||0)*(1+g/100)}
`;break}case"vol_down":S-=c.value||0,f+=`${m[n.name]} vol_down: -${c.value||0}
`;break;case"score_buff":L[0]=(L[0]||0)+(c.value||0),f+=`${m[n.name]} score_buff: +${c.value}
`;break;case"score_up":{const g=L.shift()||0,F=(c.value||0)/100*(1+g/100)*G(a,S,V?.fever||!1);E+=Math.ceil(p*F),f+=`${m[n.name]} score_up: +${Math.ceil(p*F)}
`;break}case"mental_up":T+=Math.ceil((c.value||0)/100*s),f+=`${m[n.name]} mental_up: +${Math.ceil((c.value||0)/100*s)}
`;break;case"mental_down":T-=Math.ceil((c.value||0)/100*s),f+=`${m[n.name]} mental_down: -${Math.ceil((c.value||0)/100*s)}
`,T<=0&&(T=1);break;case"ap_up":y+=Math.ceil((c.value||0)*q(A)*1e4)/1e4,f+=`${m[n.name]} ap_up: +${(c.value||0)*q(A)}
`;break;case"ap_down":y-=c.value||0,f+=`${m[n.name]} ap_down: -${c.value||0}
`;break;case"reset":z=h.length-1,f+=`${m[n.name]} reset
`;break;case"splice":h.splice(h.indexOf(n),1),z--,f+=`${m[n.name]} splice
`;break;default:throw new Error(`skill typeが不正です: ${c.type}`)}}};l&&i==="start"&&B(l,u);const Z=()=>{const n=h[z];if(!n)throw new Error("メンバーが見つかりません");const _=Math.max(n.ap-k,0);return _<=y&&x<=0?(y-=_,j.set(n,(j.get(n)||0)+1),Y++,B(n,n.skills),z=h.length-1===z?0:z+1,x+=w,!0):!1};for(let n=0;n<e.length;n++){const _=e[n];if(V=e[n-1],!_)throw new Error("noteが見つかりません");for(l&&_.fever&&!V?.fever&&i==="fever_start"&&(f+=`FEVER START
`,B(l,u)),!_.fever&&V?.fever&&(f+=`FEVER END
`),x-=_.time-Q,Q=_.time;Z(););x=Math.max(0,x);for(let R=0;R<_.normalCount+_.slideCount;R++){A++,y+=Math.ceil(ue*q(A)*1e4)/1e4,Z();const O=Math.ceil(p/X*30*G(a,S,_.fever));E+=O,f+=`combo: ${A}, score: ${E} (+${O}), ap: ${y}, mental: ${T}, vol_lv: ${P(S)*(_.fever?2:1)}
`}}return l&&i==="end"&&B(l,u),{score:E,log:f}};var le=`key	series	other_name	center_skill_condition	raw_center_skill_text	raw_skill_text	ap	center_ability_text	smile	pure	cool	mental	rarity
other	蓮ノ空女学院スクールアイドルクラブ102期生	大賀美沙知			ap_up(10);skill_count>=3 ^ splice()	0		5880	5700	5700	480	ur
rurino	悠久の舞踏会		fever_start	ap_up(8);vol_lv >= 4 ^ ap_up(8)	vol_lv <= 8 ^ vol_buff(326.25);vol_lv >= 7 ^ score_buff(435);mental_down(10*)	10	appeal_up(g103, 200);ap_reduce(all, 2)	4320	7800	5160	480	ur
rurino	アイドゥーミー！		fever_start	ap_up(20); mental_rate <= 99 ^ vol_down(1000*)	mental_up(10*); mental_rate >= 100 ^ ap_up(15); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	5	appeal_up(miracra, 200)	6960	6360	5880	520	ur
megumi	久遠の銀河へ		fever_start	score_up(204.75); skill_count >= 6 ^ score_up(286.65)	total_skill_count <= 9 ^ ap_up(15*); total_skill_count >= 10 ^ score_up(522)	10	appeal_up(g102, 200);ap_reduce(all, 2)	7200	4920	4800	510	ur
kaho	アイドゥーミー！		end	score_up(418.5)	mental_up(10*); mental_rate >= 100 ^ score_up(1134); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	12	appeal_up(all, 72)	6000	6240	6960	520	ur
sayaka	アイドゥーミー！		fever_start	score_up(877.5); mental_rate <= 99 ^ vol_down(1000*)	skill_count <= 1 ^ vol_buff(78.75); skill_count >= 2 ^ score_buff(243); mental_rate >= 100 ^ vol_up(945); mental_rate <= 99 ^ vol_down(1000*)	14	appeal_up(dollche, 200)	6120	6960	6120	520	ur
kozue	輪廻の銀河へ		fever_start	ap_up(8); skill_count >= 6 ^ ap_up(8)	skill_count <= 3 ^ vol_buff(324); skill_count <= 3 ^ reset(); skill_count >= 4 ^ score_buff(324)	10	appeal_up(g102, 200);ap_reduce(all, 2)	5160	4680	7440	480	ur
ceras	16th Birthday		start	ap_up(10)	ap_up(5); vol_buff(54.45); reset(); skill_count >= 3 ^ splice()	0	appeal_up(ceras, 400)	5760	5760	5760	480	ur`;const ne=e=>e.replace(/_([a-z])/g,(t,o)=>o.toUpperCase()),$=(e=>{const t=e.split(`
`),o=t[0].split("	");return t.slice(1).map(s=>s.split("	")).map(s=>o.reduce((a,r,l)=>(a={...a,[ne(r)]:s[l]===""||isNaN(Number(s[l]))?s[l]:Number(s[l])},a),{}))})(le),se=["<=",">="],I={1:1,2:1.1,3:1.2,4:1.3,5:1.4,6:1.5,7:1.6,8:1.7,9:1.8,10:2,11:2.2,12:2.4,13:2.6,14:3},N={vol_buff:2,vol_up:2,vol_down:2,score_up:2,score_buff:2,mental_up:2,mental_down:2,ap_up:0,ap_down:0},M=(e,t,o)=>{const p=e.rawSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(a,r,l,i)=>{if(i)return`${r}(${l})`;const u=Math.floor(Number(l)*I[t]/3*Math.pow(10,N[r])+1e-6)/Math.pow(10,N[r]);return`${r}(${u})`}),s=e.rawCenterSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(a,r,l,i)=>{if(i)return`${r}(${l})`;const u=Math.floor(Number(l)*I[o]/3*Math.pow(10,N[r])+1e-6)/Math.pow(10,N[r]);return`${r}(${u})`});return{...e,name:e.key,skill:p,centerSkillCondition:e.centerSkillCondition,centerSkill:s}};M($[0],14,14),M($[6],14,14),M($[5],14,14),M($[7],14,14),M($[4],14,14),M($[1],14,14);const W=e=>{if(!e)return;const t=se.find(o=>e?.includes(o));if(t){const[o,p]=e.split(t).map(s=>s.trim());return!o||!p?void 0:[o,t,Number(p)]}else return},re=e=>e.split(",").map(t=>t.trim()).map(t=>{const o=Number(t);return isNaN(o)?t:o}),ae=e=>{const t=[],o=[],p=[],s=e.skill.split(";");for(const a of s){const[r,l]=a.split("^").map(w=>w.trim()),i=l?r:void 0,u=l||r,[,d,v]=u.match(/^(\w+)\((.*)\)$/)||[],b={type:d,value:v?Number(v):void 0,condition:W(i)};t.push(b)}if(e.centerSkill){const a=e.centerSkill.split(";");for(const r of a){const[l,i]=r.split("^").map(k=>k.trim()),u=i?l:void 0,d=i||l,[,v,b]=d.match(/^(\w+)\((.*)\)$/)||[],w={type:v,value:b?Number(b):void 0,condition:W(u)};o.push(w)}}if(e.centerAbilityText){const a=e.centerAbilityText.split(";");for(const r of a){const[,l,i]=r.match(/^(\w+)\((.*)\)$/)||[],u={type:l,value:i?re(i):[]};p.push(u)}}return{...e,skills:t,centerSkills:o,centerAbilities:p}},ce=(e,t)=>te[t]?.includes(e)||e===t,ie=(e,t,o)=>{const s=e.find(a=>a.name===o)?.centerAbilities.find(a=>a.type==="appeal_up");return e.reduce((a,r)=>{const l=s?ce(r.name,s?.value[0]):!1,i=Math.round(r.smile*(l?(100+s?.value[1])/100:1)/(t==="smile"?1:10)),u=Math.round(r.pure*(l?(100+s?.value[1])/100:1)/(t==="pure"?1:10)),d=Math.round(r.cool*(l?(100+s?.value[1])/100:1)/(t==="cool"?1:10));return a+i+u+d},0)};function*H(e,t){if(t===0)yield[];else if(t===1)for(const o of e)yield[o];else for(let o=0;o<e.length-t+1;o++){const p=e.slice(o+1);for(const s of H(p,t-1))yield[e[o],...s]}}function*J(e){if(e.length===1)yield e;else for(let t=0;t<e.length;t++){const o=e.slice(0,t).concat(e.slice(t+1));for(const p of J(o))yield[e[t],...p]}}self.onmessage=e=>{const{requiredMembers:t,optionalMembers:o,notes:p,center:s,attribute:a}=e.data,r=50,l=6-t.length;for(const i of H(o,l)){const u=[...t,...i];if(new Set(u.map(k=>k.key!=="other"?k.key:k.otherName)).size!==6)continue;const v=u.map(k=>ae(k)),b=ie(v,a,s),w=u.reduce((k,h)=>k+h.mental,0);for(const k of J(v)){const h=oe({notes:p,convertedMembers:k,center:s,appealSum:b,mentalSum:w,masteryLevel:r,comboOffset:0});self.postMessage({message:"calcScore",data:{...h,members:u}})}}self.postMessage({message:"end"})}})();
