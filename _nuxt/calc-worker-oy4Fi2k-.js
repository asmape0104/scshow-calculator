(function(){"use strict";const L=t=>t.reduce((l,n)=>l+n.normalCount+n.slideCount,0),tt=["kaho","sayaka","kozue","tsuzuri","rurino","megumi","ginko","kosuzu","hime","ceras","izumi","other"],h={kaho:"花帆",sayaka:"さやか",kozue:"梢",tsuzuri:"綴理",rurino:"瑠璃乃",megumi:"慈",ginko:"吟子",kosuzu:"小鈴",hime:"姫芽",ceras:"セラス",izumi:"泉",other:"その他"},et={all:tt,g102:["kozue","tsuzuri","megumi"],g103:["kaho","sayaka","rurino"],g104:["ginko","kosuzu","hime","izumi"],g105:["ceras"],cerise:["kaho","kozue","ginko"],dollche:["sayaka","tsuzuri","kosuzu"],miracra:["rurino","megumi","hime"],edel:["ceras","izumi"]},lt=t=>t<=2100?Math.floor((-5+Math.sqrt(25+20*t))/10):Math.floor(20+(t-2100)/200),D=(t,l,n)=>(1+t/100)*(1+l*(n?2:1)/10),q=t=>t<10?1:t<20?1.1:t<30?1.2:t<40?1.3:t<50?1.4:1.5,ot=({notes:t,convertedMembers:l,center:n,appealSum:p,mentalSum:o,masteryLevel:s,playStyle:a="perfect",noLog:e=!1})=>{const i=l.find(r=>r.name===n),_=i?.centerSkillCondition,k=i?.centerSkills||[],d=i?.centerAbilities||[],b=d.find(r=>r.type==="cooltime_reduce"),z=d.find(r=>r.type==="ap_reduce"),g=5-Number(b?.value.amount||0),Q=Number(z?.value.amount||0),$=l.slice();let S=g,M=0,u=o,m=0;const w={_point:0,_lv:0,get point(){return this._point},set point(r){this._point=r,this._lv=lt(r)},get lv(){return this._lv}},V=[0],P=[0];let x=0,X=0;const Y=L(t);let N=0,Z=0;const U=new WeakMap,ct=60/Y;let R,f="";const O=(r,v)=>{const E=w.lv,j=u*100/o;t:for(const c of v){if(c.condition){const[y,F,W]=c.condition;let A=0;switch(y){case"skill_count":A=U.get(r)||0;break;case"total_skill_count":A=Z;break;case"vol_lv":A=E;break;case"mental_rate":A=j;break;default:throw new Error(`条件式が不正です: ${y}`)}if(W===void 0)throw new Error(`条件式が不正です: ${y}`);switch(F){case"<=":if(!(A<=W))continue t;break;case">=":if(!(A>=W))continue t;break}}switch(c.type){case"vol_buff":P[0]=(P[0]||0)+(c.value||0),e||(f+=`${h[r.name]} vol_buff: +${c.value}
`);break;case"vol_up":{const y=P[0]??0;P[0]=0,w.point+=Math.ceil((c.value||0)*(1+y/100)),e||(f+=`${h[r.name]} vol_up: +${Math.ceil((c.value||0)*(1+y/100))}
`,f+=`now voltagePoint: ${w.point}
`);break}case"vol_down":w.point-=c.value||0,w.point<0&&(w.point=0),e||(f+=`${h[r.name]} vol_down: -${c.value||0}
`);break;case"score_buff":V[0]=(V[0]||0)+(c.value||0),e||(f+=`${h[r.name]} score_buff: +${c.value}
`);break;case"score_up":{const y=V[0]??0;V[0]=0;const F=(c.value||0)/100*(1+y/100)*D(s,w.lv,R?.fever||!1);m+=Math.ceil(p*F),e||(f+=`${h[r.name]} score_up: +${Math.ceil(p*F)}
`);break}case"mental_up":u+=Math.ceil((c.value||0)/100*o),e||(f+=`${h[r.name]} mental_up: +${Math.ceil((c.value||0)/100*o)}
`);break;case"mental_down":u-=Math.ceil((c.value||0)/100*o),e||(f+=`${h[r.name]} mental_down: -${Math.ceil((c.value||0)/100*o)}
`),u<=0&&(u=1);break;case"ap_up":M+=Math.ceil((c.value||0)*q(N)*1e4),e||(f+=`${h[r.name]} ap_up: +${(c.value||0)*q(N)}
`);break;case"ap_down":M-=(c.value||0)*1e4,e||(f+=`${h[r.name]} ap_down: -${c.value||0}
`);break;case"reset":x=$.length-1,e||(f+=`${h[r.name]} reset
`);break;case"splice":$.splice($.indexOf(r),1),x--,e||(f+=`${h[r.name]} splice
`);break;default:throw new Error(`skill typeが不正です: ${c.type}`)}}};i&&_==="start"&&O(i,k);const K=()=>{const r=$[x];if(!r)throw new Error("メンバーが見つかりません");const v=Math.max(r.ap-Q,0);return v*1e4<=M&&S<=0?(M-=v*1e4,U.set(r,(U.get(r)||0)+1),Z++,O(r,r.skills),x=$.length-1===x?0:x+1,S+=g,!0):!1};for(let r=0;r<t.length;r++){const v=t[r];if(R=t[r-1],!v)throw new Error("noteが見つかりません");for(i&&v.fever&&!R?.fever&&_==="fever_start"&&(e||(f+=`FEVER START
`),O(i,k)),!v.fever&&R?.fever&&(e||(f+=`FEVER END
`)),S-=v.time-X,X=v.time;K(););S=Math.max(0,S);for(let E=0;E<v.normalCount+v.slideCount;E++){if(a==="desperate"&&u*10>o){E<v.normalCount?u-=Math.ceil(o/15):u-=Math.ceil(o*2/75),e||(f+=`miss, apPoint: ${M}, mental: ${u}, vol_lv: ${w.lv*(v.fever?2:1)}
`);continue}N++,M+=Math.ceil(ct*q(N)*1e4),K();const j=Math.ceil(p/Y*30*D(s,w.lv,v.fever));m+=j,e||(f+=`combo: ${N}, score: ${m} (+${j}), apPoint: ${M}, mental: ${u}, vol_lv: ${w.lv*(v.fever?2:1)}
`)}}return i&&_==="end"&&O(i,k),{score:m,log:f}};var at=`key	series	other_name	smile	pure	cool	mental	rarity	center_skill_condition	raw_center_skill_text	raw_skill_text	ap	center_ability_text
other	蓮ノ空女学院スクールアイドルクラブ102期生	大賀美沙知	5880	5700	5700	480	ur			ap_up(10);skill_count>=3 ^ splice()	0	
rurino	悠久の舞踏会		4320	7800	5160	480	ur	fever_start	ap_up(8);vol_lv >= 4 ^ ap_up(8)	vol_lv <= 8 ^ vol_buff(326.25);vol_lv >= 7 ^ score_buff(435);mental_down(10*)	10	appeal_up(g103, 200);ap_reduce(all, 2)
rurino	アイドゥーミー！		6960	6360	5880	520	ur	fever_start	ap_up(20); mental_rate <= 99 ^ vol_down(1000*)	mental_up(10*); mental_rate >= 100 ^ ap_up(15); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	5	appeal_up(miracra, 200)
megumi	久遠の銀河へ		7200	4920	4800	510	ur	fever_start	score_up(204.75); skill_count >= 6 ^ score_up(286.65)	total_skill_count <= 9 ^ ap_up(15*); total_skill_count >= 10 ^ score_up(522)	10	appeal_up(g102, 200);ap_reduce(all, 2)
kaho	アイドゥーミー！		6000	6240	6960	520	ur	end	score_up(418.5)	mental_up(10*); mental_rate >= 100 ^ score_up(1134); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	12	appeal_up(all, 72)
sayaka	アイドゥーミー！		6120	6960	6120	520	ur	fever_start	score_up(877.5); mental_rate <= 99 ^ vol_down(1000*)	skill_count <= 1 ^ vol_buff(78.75); skill_count >= 2 ^ score_buff(243); mental_rate >= 100 ^ vol_up(945); mental_rate <= 99 ^ vol_down(1000*)	14	appeal_up(dollche, 200)
kozue	輪廻の銀河へ		5160	4680	7440	480	ur	fever_start	ap_up(8); skill_count >= 6 ^ ap_up(8)	skill_count <= 3 ^ vol_buff(324); skill_count <= 3 ^ reset(); skill_count >= 4 ^ score_buff(324)	10	appeal_up(g102, 200);ap_reduce(all, 2)
ceras	16th Birthday		5760	5760	5760	480	br	start	ap_up(10)	ap_up(5); vol_buff(54.45); reset(); skill_count >= 3 ^ splice()	0	appeal_up(ceras, 400)
tsuzuri	幸せのリボン（SLv.12以上）		5760	5160	8520	500	lr	fever_start	vol_up(478)	vol_up(731); skill_count >= 10 ^ vol_up(1170); skill_count <= 12 ^ ap_up(20*); splice()	20	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
tsuzuri	幸せのリボン（SLv.11以下）		5760	5160	8520	500	lr	fever_start	vol_up(478)	vol_up(731); skill_count >= 10 ^ vol_up(1170); splice()	20	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
sayaka	真実の舞踏会		5160	4080	7920	490	ur	fever_start	vol_up(170); mental_rate >= 50 ^ vol_up(238)	vol_lv <= 8 ^ vol_up(326); vol_lv >= 7 ^ score_buff(558); vol_lv >= 7 ^ vol_down(50*)	10	appeal_up(g103, 200); ap_reduce(all, 2)
kaho	軌跡の舞踏会		7680	5760	3960	470	ur	end	score_up(204.75); vol_lv >= 4 ^ score_up(286.65)	vol_lv <= 8 ^ score_buff(243); vol_lv >= 7 ^ score_up(522)	10	appeal_up(g103, 200); ap_reduce(all, 2)
megumi	18th Birthday*		5760	5760	5760	480	br	fever_start	score_up(368.28); total_skill_count >= 6 ^ ap_up(8)	score_buff(123.75); vol_buff(123.75); skill_count <= 4 ^ ap_up(5*); skill_count <= 2 ^ ap_up(5*)	10	appeal_up(megumi, 400)
hime	BLAST!!		3720	7080	6240	500	ur	fever_start	mental_down(40*); score_up(326.25)	mental_rate >= 30 ^ mental_down(20*); mental_rate >= 30 ^ ap_up(8*); mental_rate >= 30 ^ score_buff(74.25); mental_rate <= 30 ^ score_up(918)	20	appeal_up(miracra, 200)
ginko	輝跡の舞踏会		4320	6720	6120	490	ur	fever_start	ap_up(8); vol_lv >= 4 ^ ap_up(8)	mental_rate <= 10 ^ score_buff(253.12); mental_rate <= 10 ^ vol_buff(253.12); mental_rate <= 10 ^ ap_up(10*); mental_down(50*)	10	appeal_up(g104, 200); ap_reduce(all, 2)
rurino	17th Birthday*		5760	5760	5760	480	br	fever_start	ap_up(12); mental_rate >= 50 ^ ap_up(8)	score_buff(123.75); vol_buff(123.75); mental_rate >= 50 ^ ap_up(5*); mental_rate >= 100 ^ ap_up(5*)	10	appeal_up(rurino, 400)
ceras	十六夜セレーネ		4560	5280	7320	490	ur	fever_start	vol_up(348)	vol_lv <= 8 ^ vol_up(243); vol_lv >= 7 ^ score_buff(324); skill_count <= 2 ^ reset()	12	appeal_up(edel, 200)
ceras	天地黎明		6960	6480	3840	480	ur	end	score_up(418.5)	skill_count <= 1 ^ vol_buff(697.5); skill_count >= 2 ^ score_up(502.2); skill_count >= 3 ^ ap_up(8)	17	appeal_up(all, 80)
kozue	奇跡の舞踏会		7200	5160	4920	480	ur	fever_start	ap_up(8); total_skill_count >= 6 ^ ap_up(8)	vol_lv <= 8 ^ vol_buff(243); vol_lv >= 7 ^ score_buff(324)	8	appeal_up(g102, 200); ap_reduce(all, 2)
ginko	37.5℃のファンタジー		6720	6120	4440	480	ur	start	mental_down(25); ap_up(5)	score_buff(170.62); mental_rate >= 30 ^ reset(); mental_rate <= 25 ^ ap_up(3)	7	appeal_up(all, 80)
izumi	天地黎明		7080	6240	3960	480	ur	start	vol_up(348)	skill_count <= 1 ^ score_buff(697.5); skill_count >= 2 ^ vol_up(418); skill_count >= 3 ^ ap_up(8)	18	appeal_up(all, 80)
kosuzu	アイマイメーデー		4200	6120	6960	480	ur	fever_start	vol_up(348)	vol_up(202); mental_rate >= 30 ^ mental_down(25); mental_rate <= 25 ^ vol_up(435); mental_rate <= 25 ^ splice()	8	appeal_up(all, 80)`;const rt=t=>t.replace(/_([a-z])/g,(l,n)=>n.toUpperCase()),T=(t=>{const l=t.split(`
`),n=l[0].split("	");return l.slice(1).map(o=>o.split("	")).map(o=>n.reduce((s,a,e)=>(s={...s,[rt(a)]:o[e]===""||isNaN(Number(o[e]))?o[e]:Number(o[e])},s),{}))})(at),nt=["<=",">="],G=Object.freeze({1:1,2:1.1,3:1.2,4:1.3,5:1.4,6:1.5,7:1.6,8:1.7,9:1.8,10:2,11:2.2,12:2.4,13:2.6,14:3}),B=Object.freeze({vol_buff:2,vol_up:2,vol_down:2,score_up:2,score_buff:2,mental_up:2,mental_down:2,ap_up:0,ap_down:0}),C=(t,l,n)=>{const p=t.rawSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(s,a,e,i)=>{if(i)return`${a}(${e})`;const _=Math.floor(Number(e)*G[l]/3*Math.pow(10,B[a])+1e-6)/Math.pow(10,B[a]);return`${a}(${_})`}),o=t.rawCenterSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(s,a,e,i)=>{if(i)return`${a}(${e})`;const _=Math.floor(Number(e)*G[n]/3*Math.pow(10,B[a])+1e-6)/Math.pow(10,B[a]);return`${a}(${_})`});return{...t,name:t.key,skill:p,centerSkillCondition:t.centerSkillCondition,centerSkill:o}};C(T[0],14,14),C(T[6],14,14),C(T[5],14,14),C(T[7],14,14),C(T[4],14,14),C(T[1],14,14);const I=t=>{if(!t)return;const l=nt.find(n=>t?.includes(n));if(l){const[n,p]=t.split(l).map(o=>o.trim());return!n||!p?void 0:[n,l,Number(p)]}else return},st=t=>{const l=[],n=[],p=[],o=t.skill.split(";").map(s=>s.trim());for(const s of o){const[a,e]=s.split("^").map(z=>z.trim()),i=e?a:void 0,_=e||a,[,k,d]=_.match(/^(\w+)\((.*)\)$/)||[],b={type:k,value:d?Number(d):void 0,condition:I(i)};l.push(b)}if(t.centerSkill){const s=t.centerSkill.split(";").map(a=>a.trim());for(const a of s){const[e,i]=a.split("^").map(g=>g.trim()),_=i?e:void 0,k=i||e,[,d,b]=k.match(/^(\w+)\((.*)\)$/)||[],z={type:d,value:b?Number(b):void 0,condition:I(_)};n.push(z)}}if(t.centerAbilityText){const s=t.centerAbilityText.split(";").map(a=>a.trim());for(const a of s){const[,e,i]=a.match(/^(\w+)\((.*)\)$/)||[],_=i?i.split(",").map(d=>d.trim()):[],k={type:e,value:e==="cooltime_reduce"?{target:"all",amount:Number(_[0])}:{target:_[0]||"all",amount:Number(_[1])}};p.push(k)}}return{...t,skills:l,centerSkills:n,centerAbilities:p}},it=(t,l)=>et[l]?.includes(t)||t===l,ut=(t,l,n)=>{const o=t.find(a=>a.name===n)?.centerAbilities.find(a=>a.type==="appeal_up"),s=t.reduce((a,e)=>{const i=o?it(e.name,o?.value.target):!1,_=Math.ceil(e.smile*(i?(100+(o?.value.amount||0))/100:1)),k=Math.ceil(e.pure*(i?(100+(o?.value.amount||0))/100:1)),d=Math.ceil(e.cool*(i?(100+(o?.value.amount||0))/100:1));return{smile:a.smile+_,pure:a.pure+k,cool:a.cool+d}},{smile:0,pure:0,cool:0});return s.smile=Math.round(s.smile/(l==="smile"?1:10)),s.pure=Math.round(s.pure/(l==="pure"?1:10)),s.cool=Math.round(s.cool/(l==="cool"?1:10)),s.smile+s.pure+s.cool};function*H(t,l){if(l===0)yield[];else if(l===1)for(const n of t)yield[n];else for(let n=0;n<t.length-l+1;n++){const p=t.slice(n+1);for(const o of H(p,l-1))yield[t[n],...o]}}function*J(t){if(t.length===1)yield t;else for(let l=0;l<t.length;l++){const n=t.slice(0,l).concat(t.slice(l+1));for(const p of J(n))yield[t[l],...p]}}self.onmessage=t=>{const{requiredMembers:l,optionalMembers:n,notes:p,center:o,attribute:s,masteryLevel:a,playStyle:e,includingCenterOnly:i,noLog:_}=t.data;let k=0;const d=6-l.length,b=new WeakMap;for(const z of H(n,d)){const g=[...l,...z];if(i&&!g.some(u=>u.key===o)||new Set(g.map(u=>u.key!=="other"?u.key:u.otherName)).size!==6)continue;const $=g.map(u=>{if(b.has(u))return b.get(u);const m=st(u);return b.set(u,m),m}),S=ut($,s,o),M=g.reduce((u,m)=>u+m.mental,0);for(const u of J($))try{const m=ot({notes:p,convertedMembers:u,center:o,appealSum:S,mentalSum:M,masteryLevel:a,playStyle:e,noLog:_});m.score>k&&(k=m.score,self.postMessage({message:"calcScore",data:{...m,members:u}}))}catch(m){console.error(m)}}self.postMessage({message:"end"})}})();
