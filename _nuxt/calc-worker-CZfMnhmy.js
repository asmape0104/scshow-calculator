(function(){"use strict";const K=t=>t.reduce((e,l)=>e+l.normalCount+l.slideCount,0),tt=["kaho","sayaka","kozue","tsuzuri","rurino","megumi","ginko","kosuzu","hime","ceras","izumi","other"],m={kaho:"花帆",sayaka:"さやか",kozue:"梢",tsuzuri:"綴理",rurino:"瑠璃乃",megumi:"慈",ginko:"吟子",kosuzu:"小鈴",hime:"姫芽",ceras:"セラス",izumi:"泉",other:"その他"},et={all:tt,g102:["kozue","tsuzuri","megumi"],g103:["kaho","sayaka","rurino"],g104:["ginko","kosuzu","hime","izumi"],g105:["ceras"],cerise:["kaho","kozue","ginko"],dollche:["sayaka","tsuzuri","kosuzu"],miracra:["rurino","megumi","hime"],edel:["ceras","izumi"]},F=t=>t<=2100?Math.floor((-5+Math.sqrt(25+20*t))/10):Math.floor(20+(t-2100)/200),G=(t,e,l)=>(1+t/100)*(1+F(e)*(l?2:1)/10),P=t=>t<10?1:t<20?1.1:t<30?1.2:t<40?1.3:t<50?1.4:1.5,lt=({notes:t,convertedMembers:e,center:l,appealSum:p,mentalSum:r,masteryLevel:s,comboOffset:a})=>{const o=e.find(n=>n.name===l),i=o?.centerSkillCondition,u=o?.centerSkills||[],k=o?.centerAbilities||[],d=k.find(n=>n.type==="cooltime_reduce"),b=k.find(n=>n.type==="ap_reduce"),g=5-Number(d?.value[0]||0),v=Number(b?.value[1]||0),h=e.slice();let x=g,y=0,S=r,E=0,T=0;const q=[],U=[];let z=0,Q=0;const X=K(t);let A=0,Y=0;const j=new WeakMap,ut=60/(X-0);let B,_="";const V=(n,f)=>{const R=F(T),L=S*100/r;t:for(const c of f){if(c.condition){const[w,O,D]=c.condition;let C=0;switch(w){case"skill_count":C=j.get(n)||0;break;case"total_skill_count":C=Y;break;case"vol_lv":C=R;break;case"mental_rate":C=L;break;default:throw new Error(`条件式が不正です: ${w}`)}if(D===void 0)throw new Error(`条件式が不正です: ${w}`);switch(O){case"<=":if(!(C<=D))continue t;break;case">=":if(!(C>=D))continue t;break}}switch(c.type){case"vol_buff":U[0]=(U[0]||0)+(c.value||0),_+=`${m[n.name]} vol_buff: +${c.value}
`;break;case"vol_up":{const w=U.shift()||0;T+=(c.value||0)*(1+w/100),_+=`${m[n.name]} vol_up: +${(c.value||0)*(1+w/100)}
`;break}case"vol_down":T-=c.value||0,_+=`${m[n.name]} vol_down: -${c.value||0}
`;break;case"score_buff":q[0]=(q[0]||0)+(c.value||0),_+=`${m[n.name]} score_buff: +${c.value}
`;break;case"score_up":{const w=q.shift()||0,O=(c.value||0)/100*(1+w/100)*G(s,T,B?.fever||!1);E+=Math.ceil(p*O),_+=`${m[n.name]} score_up: +${Math.ceil(p*O)}
`;break}case"mental_up":S+=Math.ceil((c.value||0)/100*r),_+=`${m[n.name]} mental_up: +${Math.ceil((c.value||0)/100*r)}
`;break;case"mental_down":S-=Math.ceil((c.value||0)/100*r),_+=`${m[n.name]} mental_down: -${Math.ceil((c.value||0)/100*r)}
`,S<=0&&(S=1);break;case"ap_up":y+=Math.ceil((c.value||0)*P(A)*1e4)/1e4,_+=`${m[n.name]} ap_up: +${(c.value||0)*P(A)}
`;break;case"ap_down":y-=c.value||0,_+=`${m[n.name]} ap_down: -${c.value||0}
`;break;case"reset":z=h.length-1,_+=`${m[n.name]} reset
`;break;case"splice":h.splice(h.indexOf(n),1),z--,_+=`${m[n.name]} splice
`;break;default:throw new Error(`skill typeが不正です: ${c.type}`)}}};o&&i==="start"&&V(o,u);const Z=()=>{const n=h[z];if(!n)throw new Error("メンバーが見つかりません");const f=Math.max(n.ap-v,0);return f<=y&&x<=0?(y-=f,j.set(n,(j.get(n)||0)+1),Y++,V(n,n.skills),z=h.length-1===z?0:z+1,x+=g,!0):!1};for(let n=0;n<t.length;n++){const f=t[n];if(B=t[n-1],!f)throw new Error("noteが見つかりません");for(o&&f.fever&&!B?.fever&&i==="fever_start"&&(_+=`FEVER START
`,V(o,u)),!f.fever&&B?.fever&&(_+=`FEVER END
`),x-=f.time-Q,Q=f.time;Z(););x=Math.max(0,x);for(let R=0;R<f.normalCount+f.slideCount;R++){A++,y+=Math.ceil(ut*P(A)*1e4)/1e4,Z();const L=Math.ceil(p/X*30*G(s,T,f.fever));E+=L,_+=`combo: ${A}, score: ${E} (+${L}), ap: ${y}, mental: ${S}, vol_lv: ${F(T)*(f.fever?2:1)}
`}}return o&&i==="end"&&V(o,u),{score:E,log:_}};var ot=`key	series	other_name	smile	pure	cool	mental	rarity	center_skill_condition	raw_center_skill_text	raw_skill_text	ap	center_ability_text
other	蓮ノ空女学院スクールアイドルクラブ102期生	大賀美沙知	5880	5700	5700	480	ur			ap_up(10);skill_count>=3 ^ splice()	0	
rurino	悠久の舞踏会		4320	7800	5160	480	ur	fever_start	ap_up(8);vol_lv >= 4 ^ ap_up(8)	vol_lv <= 8 ^ vol_buff(326.25);vol_lv >= 7 ^ score_buff(435);mental_down(10*)	10	appeal_up(g103, 200);ap_reduce(all, 2)
rurino	アイドゥーミー！		6960	6360	5880	520	ur	fever_start	ap_up(20); mental_rate <= 99 ^ vol_down(1000*)	mental_up(10*); mental_rate >= 100 ^ ap_up(15); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	5	appeal_up(miracra, 200)
megumi	久遠の銀河へ		7200	4920	4800	510	ur	fever_start	score_up(204.75); skill_count >= 6 ^ score_up(286.65)	total_skill_count <= 9 ^ ap_up(15*); total_skill_count >= 10 ^ score_up(522)	10	appeal_up(g102, 200);ap_reduce(all, 2)
kaho	アイドゥーミー！		6000	6240	6960	520	ur	end	score_up(418.5)	mental_up(10*); mental_rate >= 100 ^ score_up(1134); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	12	appeal_up(all, 72)
sayaka	アイドゥーミー！		6120	6960	6120	520	ur	fever_start	score_up(877.5); mental_rate <= 99 ^ vol_down(1000*)	skill_count <= 1 ^ vol_buff(78.75); skill_count >= 2 ^ score_buff(243); mental_rate >= 100 ^ vol_up(945); mental_rate <= 99 ^ vol_down(1000*)	14	appeal_up(dollche, 200)
kozue	輪廻の銀河へ		5160	4680	7440	480	ur	fever_start	ap_up(8); skill_count >= 6 ^ ap_up(8)	skill_count <= 3 ^ vol_buff(324); skill_count <= 3 ^ reset(); skill_count >= 4 ^ score_buff(324)	10	appeal_up(g102, 200);ap_reduce(all, 2)
ceras	16th Birthday		5760	5760	5760	480	br	start	ap_up(10)	ap_up(5); vol_buff(54.45); reset(); skill_count >= 3 ^ splice()	0	appeal_up(ceras, 400)
tsuzuri	幸せのリボン（SLv.12以上）		5760	5160	8520	500	lr	fever_start	vol_up(478)	vol_up(731); skill_count >= 10 ^ vol_up(1170); skill_count <= 12 ^ ap_up(20*); splice()	20	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
tsuzuri	幸せのリボン（SLv.11以下）		5760	5160	8520	500	lr	fever_start	vol_up(478)	vol_up(731); skill_count >= 10 ^ vol_up(1170); splice()	20	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
sayaka	真実の舞踏会		5160	4080	7920	490	ur	fever_start	vol_up(170); mental_rate >= 50 ^ vol_up(238)	vol_lv <= 8 ^ vol_up(326); vol_lv >= 7 ^ score_buff(558); vol_lv >= 7 ^ vol_down(50*)	10	appeal_up(g103, 200); ap_reduce(all, 2)
kaho	軌跡の舞踏会		7680	5760	3960	470	ur	end	score_up(204.75); vol_lv >= 4 ^ score_up(286.65)	vol_lv <= 8 ^ score_buff(243); vol_lv >= 7 ^ score_up(522)	10	appeal_up(g103, 200); ap_reduce(all, 2)
megumi	18th Birthday*		5760	5760	5760	480	br	fever_start	score_up(368.28); total_skill_count >= 6 ^ ap_up(8)	score_buff(123.75); vol_buff(123.75); skill_count <= 4 ^ ap_up(5*); skill_count <= 2 ^ ap_up(5*)	10	appeal_up(megumi, 400)
hime	BLAST!!		3720	7080	6240	500	ur	fever_start	mental_down(40*); score_up(326.25)	mental_rate >= 30 ^ mental_down(20*); mental_rate >= 30 ^ ap_up(8*); mental_rate >= 30 ^ score_buff(74.25); mental_rate <= 30 ^ score_up(918)	20	appeal_up(miracra, 200)`;const nt=t=>t.replace(/_([a-z])/g,(e,l)=>l.toUpperCase()),$=(t=>{const e=t.split(`
`),l=e[0].split("	");return e.slice(1).map(r=>r.split("	")).map(r=>l.reduce((s,a,o)=>(s={...s,[nt(a)]:r[o]===""||isNaN(Number(r[o]))?r[o]:Number(r[o])},s),{}))})(ot),rt=["<=",">="],I={1:1,2:1.1,3:1.2,4:1.3,5:1.4,6:1.5,7:1.6,8:1.7,9:1.8,10:2,11:2.2,12:2.4,13:2.6,14:3},N={vol_buff:2,vol_up:2,vol_down:2,score_up:2,score_buff:2,mental_up:2,mental_down:2,ap_up:0,ap_down:0},M=(t,e,l)=>{const p=t.rawSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(s,a,o,i)=>{if(i)return`${a}(${o})`;const u=Math.floor(Number(o)*I[e]/3*Math.pow(10,N[a])+1e-6)/Math.pow(10,N[a]);return`${a}(${u})`}),r=t.rawCenterSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(s,a,o,i)=>{if(i)return`${a}(${o})`;const u=Math.floor(Number(o)*I[l]/3*Math.pow(10,N[a])+1e-6)/Math.pow(10,N[a]);return`${a}(${u})`});return{...t,name:t.key,skill:p,centerSkillCondition:t.centerSkillCondition,centerSkill:r}};M($[0],14,14),M($[6],14,14),M($[5],14,14),M($[7],14,14),M($[4],14,14),M($[1],14,14);const W=t=>{if(!t)return;const e=rt.find(l=>t?.includes(l));if(e){const[l,p]=t.split(e).map(r=>r.trim());return!l||!p?void 0:[l,e,Number(p)]}else return},at=t=>t.split(",").map(e=>e.trim()).map(e=>{const l=Number(e);return isNaN(l)?e:l}),st=t=>{const e=[],l=[],p=[],r=t.skill.split(";").map(s=>s.trim());for(const s of r){const[a,o]=s.split("^").map(g=>g.trim()),i=o?a:void 0,u=o||a,[,k,d]=u.match(/^(\w+)\((.*)\)$/)||[],b={type:k,value:d?Number(d):void 0,condition:W(i)};e.push(b)}if(t.centerSkill){const s=t.centerSkill.split(";").map(a=>a.trim());for(const a of s){const[o,i]=a.split("^").map(v=>v.trim()),u=i?o:void 0,k=i||o,[,d,b]=k.match(/^(\w+)\((.*)\)$/)||[],g={type:d,value:b?Number(b):void 0,condition:W(u)};l.push(g)}}if(t.centerAbilityText){const s=t.centerAbilityText.split(";").map(a=>a.trim());for(const a of s){const[,o,i]=a.match(/^(\w+)\((.*)\)$/)||[],u={type:o,value:i?at(i):[]};p.push(u)}}return{...t,skills:e,centerSkills:l,centerAbilities:p}},ct=(t,e)=>et[e]?.includes(t)||t===e,it=(t,e,l)=>{const r=t.find(s=>s.name===l)?.centerAbilities.find(s=>s.type==="appeal_up");return t.reduce((s,a)=>{const o=r?ct(a.name,r?.value[0]):!1,i=Math.round(a.smile*(o?(100+r?.value[1])/100:1)/(e==="smile"?1:10)),u=Math.round(a.pure*(o?(100+r?.value[1])/100:1)/(e==="pure"?1:10)),k=Math.round(a.cool*(o?(100+r?.value[1])/100:1)/(e==="cool"?1:10));return s+i+u+k},0)};function*H(t,e){if(e===0)yield[];else if(e===1)for(const l of t)yield[l];else for(let l=0;l<t.length-e+1;l++){const p=t.slice(l+1);for(const r of H(p,e-1))yield[t[l],...r]}}function*J(t){if(t.length===1)yield t;else for(let e=0;e<t.length;e++){const l=t.slice(0,e).concat(t.slice(e+1));for(const p of J(l))yield[t[e],...p]}}self.onmessage=t=>{const{requiredMembers:e,optionalMembers:l,notes:p,center:r,attribute:s}=t.data,a=50,o=6-e.length;for(const i of H(l,o)){const u=[...e,...i];if(new Set(u.map(v=>v.key!=="other"?v.key:v.otherName)).size!==6)continue;const d=u.map(v=>st(v)),b=it(d,s,r),g=u.reduce((v,h)=>v+h.mental,0);for(const v of J(d)){const h=lt({notes:p,convertedMembers:v,center:r,appealSum:b,mentalSum:g,masteryLevel:a,comboOffset:0});self.postMessage({message:"calcScore",data:{...h,members:u}})}}self.postMessage({message:"end"})}})();
