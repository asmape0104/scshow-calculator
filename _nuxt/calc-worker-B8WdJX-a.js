(function(){"use strict";const tt=t=>t.reduce((e,l)=>e+l.normalCount+l.slideCount,0),et=["kaho","sayaka","kozue","tsuzuri","rurino","megumi","ginko","kosuzu","hime","ceras","izumi","other"],k={kaho:"花帆",sayaka:"さやか",kozue:"梢",tsuzuri:"綴理",rurino:"瑠璃乃",megumi:"慈",ginko:"吟子",kosuzu:"小鈴",hime:"姫芽",ceras:"セラス",izumi:"泉",other:"その他"},lt={all:et,g102:["kozue","tsuzuri","megumi"],g103:["kaho","sayaka","rurino"],g104:["ginko","kosuzu","hime","izumi"],g105:["ceras"],cerise:["kaho","kozue","ginko"],dollche:["sayaka","tsuzuri","kosuzu"],miracra:["rurino","megumi","hime"],edel:["ceras","izumi"]},B=t=>t<=2100?Math.floor((-5+Math.sqrt(25+20*t))/10):Math.floor(20+(t-2100)/200),I=(t,e,l)=>(1+t/100)*(1+B(e)*(l?2:1)/10),q=t=>t<10?1:t<20?1.1:t<30?1.2:t<40?1.3:t<50?1.4:1.5,ot=({notes:t,convertedMembers:e,center:l,appealSum:u,mentalSum:o,masteryLevel:n,comboOffset:r,playStyle:s="perfect"})=>{const c=e.find(a=>a.name===l),p=c?.centerSkillCondition,v=c?.centerSkills||[],d=c?.centerAbilities||[],g=d.find(a=>a.type==="cooltime_reduce"),$=d.find(a=>a.type==="ap_reduce"),z=5-Number(g?.value[0]||0),m=Number($?.value[1]||0),w=e.slice();let x=z,y=0,h=o,R=0,b=0;const U=[],j=[];let C=0,X=0;const Y=tt(t);let A=0,Z=0;const D=new WeakMap,pt=60/(Y-0);let L,_="";const O=(a,f)=>{const E=B(b),P=h*100/o;t:for(const i of f){if(i.condition){const[M,F,G]=i.condition;let N=0;switch(M){case"skill_count":N=D.get(a)||0;break;case"total_skill_count":N=Z;break;case"vol_lv":N=E;break;case"mental_rate":N=P;break;default:throw new Error(`条件式が不正です: ${M}`)}if(G===void 0)throw new Error(`条件式が不正です: ${M}`);switch(F){case"<=":if(!(N<=G))continue t;break;case">=":if(!(N>=G))continue t;break}}switch(i.type){case"vol_buff":j[0]=(j[0]||0)+(i.value||0),_+=`${k[a.name]} vol_buff: +${i.value}
`;break;case"vol_up":{const M=j.shift()||0;b+=Math.ceil((i.value||0)*(1+M/100)),_+=`${k[a.name]} vol_up: +${Math.ceil((i.value||0)*(1+M/100))}
`,_+=`now voltagePoint: ${b}
`;break}case"vol_down":b-=i.value||0,b<0&&(b=0),_+=`${k[a.name]} vol_down: -${i.value||0}
`;break;case"score_buff":U[0]=(U[0]||0)+(i.value||0),_+=`${k[a.name]} score_buff: +${i.value}
`;break;case"score_up":{const M=U.shift()||0,F=(i.value||0)/100*(1+M/100)*I(n,b,L?.fever||!1);R+=Math.ceil(u*F),_+=`${k[a.name]} score_up: +${Math.ceil(u*F)}
`;break}case"mental_up":h+=Math.ceil((i.value||0)/100*o),_+=`${k[a.name]} mental_up: +${Math.ceil((i.value||0)/100*o)}
`;break;case"mental_down":h-=Math.ceil((i.value||0)/100*o),_+=`${k[a.name]} mental_down: -${Math.ceil((i.value||0)/100*o)}
`,h<=0&&(h=1);break;case"ap_up":y+=Math.ceil((i.value||0)*q(A)*1e4)/1e4,_+=`${k[a.name]} ap_up: +${(i.value||0)*q(A)}
`;break;case"ap_down":y-=i.value||0,_+=`${k[a.name]} ap_down: -${i.value||0}
`;break;case"reset":C=w.length-1,_+=`${k[a.name]} reset
`;break;case"splice":w.splice(w.indexOf(a),1),C--,_+=`${k[a.name]} splice
`;break;default:throw new Error(`skill typeが不正です: ${i.type}`)}}};c&&p==="start"&&O(c,v);const K=()=>{const a=w[C];if(!a)throw new Error("メンバーが見つかりません");const f=Math.max(a.ap-m,0);return f<=y&&x<=0?(y-=f,D.set(a,(D.get(a)||0)+1),Z++,O(a,a.skills),C=w.length-1===C?0:C+1,x+=z,!0):!1};for(let a=0;a<t.length;a++){const f=t[a];if(L=t[a-1],!f)throw new Error("noteが見つかりません");for(c&&f.fever&&!L?.fever&&p==="fever_start"&&(_+=`FEVER START
`,O(c,v)),!f.fever&&L?.fever&&(_+=`FEVER END
`),x-=f.time-X,X=f.time;K(););x=Math.max(0,x);for(let E=0;E<f.normalCount+f.slideCount;E++){if(s==="desperate"&&h*10>o){E<f.normalCount?h-=Math.ceil(o/15):h-=Math.ceil(o*2/75),_+=`miss, ap: ${y}, mental: ${h}, vol_lv: ${B(b)*(f.fever?2:1)}
`;continue}A++,y+=Math.ceil(pt*q(A)*1e4)/1e4,K();const P=Math.ceil(u/Y*30*I(n,b,f.fever));R+=P,_+=`combo: ${A}, score: ${R} (+${P}), ap: ${y}, mental: ${h}, vol_lv: ${B(b)*(f.fever?2:1)}
`}}return c&&p==="end"&&O(c,v),{score:R,log:_}};var rt=`key	series	other_name	smile	pure	cool	mental	rarity	center_skill_condition	raw_center_skill_text	raw_skill_text	ap	center_ability_text
other	蓮ノ空女学院スクールアイドルクラブ102期生	大賀美沙知	5880	5700	5700	480	ur			ap_up(10);skill_count>=3 ^ splice()	0	
rurino	悠久の舞踏会		4320	7800	5160	480	ur	fever_start	ap_up(8);vol_lv >= 4 ^ ap_up(8)	vol_lv <= 8 ^ vol_buff(326.25);vol_lv >= 7 ^ score_buff(435);mental_down(10*)	10	appeal_up(g103, 200);ap_reduce(all, 2)
rurino	アイドゥーミー！		6960	6360	5880	520	ur	fever_start	ap_up(20); mental_rate <= 99 ^ vol_down(1000*)	mental_up(10*); mental_rate >= 100 ^ ap_up(15); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	5	appeal_up(miracra, 200)
megumi	久遠の銀河へ		7200	4920	4800	510	ur	fever_start	score_up(204.75); skill_count >= 6 ^ score_up(286.65)	total_skill_count <= 9 ^ ap_up(15*); total_skill_count >= 10 ^ score_up(522)	10	appeal_up(g102, 200);ap_reduce(all, 2)
kaho	アイドゥーミー！		6000	6240	6960	520	ur	end	score_up(418.5)	mental_up(10*); mental_rate >= 100 ^ score_up(1134); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	12	appeal_up(all, 72)
sayaka	アイドゥーミー！		6120	6960	6120	520	ur	fever_start	score_up(877.5); mental_rate <= 99 ^ vol_down(1000*)	skill_count <= 1 ^ vol_buff(78.75); skill_count >= 2 ^ score_buff(243); mental_rate >= 100 ^ vol_up(945); mental_rate <= 99 ^ vol_down(1000*)	14	appeal_up(dollche, 200)
kozue	輪廻の銀河へ		5160	4680	7440	480	ur	fever_start	ap_up(8); skill_count >= 6 ^ ap_up(8)	skill_count <= 3 ^ vol_buff(324); skill_count <= 3 ^ reset(); skill_count >= 4 ^ score_buff(324)	10	appeal_up(g102, 200);ap_reduce(all, 2)
ceras	16th Birthday		5760	5760	5760	480	br	start	ap_up(10)	ap_up(5); vol_buff(54.45); reset(); skill_count >= 3 ^ splice()	0	appeal_up(ceras, 400)
tsuzuri	幸せのリボン（SLv.12以上）		5760	5160	8520	500	lr	fever_start	vol_up(478)	vol_up(731); skill_count >= 10 ^ vol_up(1170); skill_count <= 12 ^ ap_up(20*); splice()	20	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
tsuzuri	幸せのリボン（SLv.11以下）		5760	5160	8520	500	lr	fever_start	vol_up(478)	vol_up(731); skill_count >= 10 ^ vol_up(1170); splice()	20	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
sayaka	真実の舞踏会		5160	4080	7920	490	ur	fever_start	vol_up(170); mental_rate >= 50 ^ vol_up(238)	vol_lv <= 8 ^ vol_up(326); vol_lv >= 7 ^ score_buff(558); vol_lv >= 7 ^ vol_down(50*)	10	appeal_up(g103, 200); ap_reduce(all, 2)
kaho	軌跡の舞踏会		7680	5760	3960	470	ur	end	score_up(204.75); vol_lv >= 4 ^ score_up(286.65)	vol_lv <= 8 ^ score_buff(243); vol_lv >= 7 ^ score_up(522)	10	appeal_up(g103, 200); ap_reduce(all, 2)
megumi	18th Birthday*		5760	5760	5760	480	br	fever_start	score_up(368.28); total_skill_count >= 6 ^ ap_up(8)	score_buff(123.75); vol_buff(123.75); skill_count <= 4 ^ ap_up(5*); skill_count <= 2 ^ ap_up(5*)	10	appeal_up(megumi, 400)
hime	BLAST!!		3720	7080	6240	500	ur	fever_start	mental_down(40*); score_up(326.25)	mental_rate >= 30 ^ mental_down(20*); mental_rate >= 30 ^ ap_up(8*); mental_rate >= 30 ^ score_buff(74.25); mental_rate <= 30 ^ score_up(918)	20	appeal_up(miracra, 200)
ginko	輝跡の舞踏会		4320	6720	6120	490	ur	fever_start	ap_up(8); vol_lv >= 4 ^ ap_up(8)	mental_rate <= 10 ^ score_buff(253.12); mental_rate <= 10 ^ vol_buff(253.12); mental_rate <= 10 ^ ap_up(10*); mental_down(50*)	10	appeal_up(g104, 200); ap_reduce(all, 2)`;const at=t=>t.replace(/_([a-z])/g,(e,l)=>l.toUpperCase()),T=(t=>{const e=t.split(`
`),l=e[0].split("	");return e.slice(1).map(o=>o.split("	")).map(o=>l.reduce((n,r,s)=>(n={...n,[at(r)]:o[s]===""||isNaN(Number(o[s]))?o[s]:Number(o[s])},n),{}))})(rt),nt=["<=",">="],W={1:1,2:1.1,3:1.2,4:1.3,5:1.4,6:1.5,7:1.6,8:1.7,9:1.8,10:2,11:2.2,12:2.4,13:2.6,14:3},V={vol_buff:2,vol_up:2,vol_down:2,score_up:2,score_buff:2,mental_up:2,mental_down:2,ap_up:0,ap_down:0},S=(t,e,l)=>{const u=t.rawSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(n,r,s,c)=>{if(c)return`${r}(${s})`;const p=Math.floor(Number(s)*W[e]/3*Math.pow(10,V[r])+1e-6)/Math.pow(10,V[r]);return`${r}(${p})`}),o=t.rawCenterSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(n,r,s,c)=>{if(c)return`${r}(${s})`;const p=Math.floor(Number(s)*W[l]/3*Math.pow(10,V[r])+1e-6)/Math.pow(10,V[r]);return`${r}(${p})`});return{...t,name:t.key,skill:u,centerSkillCondition:t.centerSkillCondition,centerSkill:o}};S(T[0],14,14),S(T[6],14,14),S(T[5],14,14),S(T[7],14,14),S(T[4],14,14),S(T[1],14,14);const H=t=>{if(!t)return;const e=nt.find(l=>t?.includes(l));if(e){const[l,u]=t.split(e).map(o=>o.trim());return!l||!u?void 0:[l,e,Number(u)]}else return},st=t=>t.split(",").map(e=>e.trim()).map(e=>{const l=Number(e);return isNaN(l)?e:l}),ct=t=>{const e=[],l=[],u=[],o=t.skill.split(";").map(n=>n.trim());for(const n of o){const[r,s]=n.split("^").map($=>$.trim()),c=s?r:void 0,p=s||r,[,v,d]=p.match(/^(\w+)\((.*)\)$/)||[],g={type:v,value:d?Number(d):void 0,condition:H(c)};e.push(g)}if(t.centerSkill){const n=t.centerSkill.split(";").map(r=>r.trim());for(const r of n){const[s,c]=r.split("^").map(z=>z.trim()),p=c?s:void 0,v=c||s,[,d,g]=v.match(/^(\w+)\((.*)\)$/)||[],$={type:d,value:g?Number(g):void 0,condition:H(p)};l.push($)}}if(t.centerAbilityText){const n=t.centerAbilityText.split(";").map(r=>r.trim());for(const r of n){const[,s,c]=r.match(/^(\w+)\((.*)\)$/)||[],p={type:s,value:c?st(c):[]};u.push(p)}}return{...t,skills:e,centerSkills:l,centerAbilities:u}},it=(t,e)=>lt[e]?.includes(t)||t===e,ut=(t,e,l)=>{const o=t.find(r=>r.name===l)?.centerAbilities.find(r=>r.type==="appeal_up"),n=t.reduce((r,s)=>{const c=o?it(s.name,o?.value[0]):!1,p=Math.ceil(s.smile*(c?(100+(Number(o?.value[1])||0))/100:1)),v=Math.ceil(s.pure*(c?(100+(Number(o?.value[1])||0))/100:1)),d=Math.ceil(s.cool*(c?(100+(Number(o?.value[1])||0))/100:1));return{smile:r.smile+p,pure:r.pure+v,cool:r.cool+d}},{smile:0,pure:0,cool:0});return n.smile=Math.round(n.smile/(e==="smile"?1:10)),n.pure=Math.round(n.pure/(e==="pure"?1:10)),n.cool=Math.round(n.cool/(e==="cool"?1:10)),n.smile+n.pure+n.cool};function*J(t,e){if(e===0)yield[];else if(e===1)for(const l of t)yield[l];else for(let l=0;l<t.length-e+1;l++){const u=t.slice(l+1);for(const o of J(u,e-1))yield[t[l],...o]}}function*Q(t){if(t.length===1)yield t;else for(let e=0;e<t.length;e++){const l=t.slice(0,e).concat(t.slice(e+1));for(const u of Q(l))yield[t[e],...u]}}self.onmessage=t=>{const{requiredMembers:e,optionalMembers:l,notes:u,center:o,attribute:n,masteryLevel:r,playStyle:s}=t.data,c=6-e.length;for(const p of J(l,c)){const v=[...e,...p];if(new Set(v.map(m=>m.key!=="other"?m.key:m.otherName)).size!==6)continue;const g=v.map(m=>ct(m)),$=ut(g,n,o),z=v.reduce((m,w)=>m+w.mental,0);for(const m of Q(g)){const w=ot({notes:u,convertedMembers:m,center:o,appealSum:$,mentalSum:z,masteryLevel:r,comboOffset:0,playStyle:s});self.postMessage({message:"calcScore",data:{...w,members:m}})}}self.postMessage({message:"end"})}})();
