(function(){"use strict";const L=t=>t.reduce((l,n)=>l+n.normalCount+n.slideCount,0),tt=["kaho","sayaka","kozue","tsuzuri","rurino","megumi","ginko","kosuzu","hime","ceras","izumi","other"],b={kaho:"花帆",sayaka:"さやか",kozue:"梢",tsuzuri:"綴理",rurino:"瑠璃乃",megumi:"慈",ginko:"吟子",kosuzu:"小鈴",hime:"姫芽",ceras:"セラス",izumi:"泉",other:"その他"},et={all:tt,g102:["kozue","tsuzuri","megumi"],g103:["kaho","sayaka","rurino"],g104:["ginko","kosuzu","hime","izumi"],g105:["ceras"],cerise:["kaho","kozue","ginko"],dollche:["sayaka","tsuzuri","kosuzu"],miracra:["rurino","megumi","hime"],edel:["ceras","izumi"]},lt=t=>t<=2100?Math.floor((-5+Math.sqrt(25+20*t))/10):Math.floor(20+(t-2100)/200),G=(t,l,n)=>(1+t/100)*(1+l*(n?2:1)/10),q=t=>t<10?1:t<20?1.1:t<30?1.2:t<40?1.3:t<50?1.4:1.5,ot=({notes:t,convertedMembers:l,center:n,appealSum:_,mentalSum:r,masteryLevel:u,playStyle:o="perfect",noLog:e=!1})=>{const i=l.find(a=>a.name===n),f=i?.centerSkillCondition,h=i?.centerSkills||[],k=i?.centerAbilities||[],$=k.find(a=>a.type==="cooltime_reduce"),g=k.find(a=>a.type==="ap_reduce"),A=5-Number($?.value.amount||0),M=Number(g?.value.amount||0),w=l.slice();let z=A,y=0,s=r,c=0;const v={_point:0,_lv:0,get point(){return this._point},set point(a){this._point=a,this._lv=lt(a)},get lv(){return this._lv}},C=[0],O=[0];let N=0,X=0;const Y=L(t);let B=0,Z=0;const W=new WeakMap,ct=60/Y;let V,d="";const F=(a,m)=>{const R=v.lv,j=s*100/r;t:for(const p of m){if(p.condition){const[x,U,D]=p.condition;let P=0;switch(x){case"skill_count":P=W.get(a)||0;break;case"total_skill_count":P=Z;break;case"vol_lv":P=R;break;case"mental_rate":P=j;break;default:throw new Error(`条件式が不正です: ${x}`)}if(D===void 0)throw new Error(`条件式が不正です: ${x}`);switch(U){case"<=":if(!(P<=D))continue t;break;case">=":if(!(P>=D))continue t;break}}switch(p.type){case"vol_buff":O[0]=(O[0]||0)+(p.value||0),e||(d+=`${b[a.name]} vol_buff: +${p.value}
`);break;case"vol_up":{const x=O[0]??0;O[0]=0,v.point+=Math.ceil((p.value||0)*(1+x/100)),e||(d+=`${b[a.name]} vol_up: +${Math.ceil((p.value||0)*(1+x/100))}
`,d+=`now voltagePoint: ${v.point}
`);break}case"vol_down":v.point-=p.value||0,v.point<0&&(v.point=0),e||(d+=`${b[a.name]} vol_down: -${p.value||0}
`);break;case"score_buff":C[0]=(C[0]||0)+(p.value||0),e||(d+=`${b[a.name]} score_buff: +${p.value}
`);break;case"score_up":{const x=C[0]??0;C[0]=0;const U=(p.value||0)/100*(1+x/100)*G(u,v.lv,V?.fever||!1);c+=Math.ceil(_*U),e||(d+=`${b[a.name]} score_up: +${Math.ceil(_*U)}
`);break}case"mental_up":s+=Math.ceil((p.value||0)/100*r),e||(d+=`${b[a.name]} mental_up: +${Math.ceil((p.value||0)/100*r)}
`);break;case"mental_down":s-=Math.ceil((p.value||0)/100*r),e||(d+=`${b[a.name]} mental_down: -${Math.ceil((p.value||0)/100*r)}
`),s<=0&&(s=1);break;case"ap_up":y+=Math.ceil((p.value||0)*q(B)*1e4),e||(d+=`${b[a.name]} ap_up: +${(p.value||0)*q(B)}
`);break;case"ap_down":y-=(p.value||0)*1e4,e||(d+=`${b[a.name]} ap_down: -${p.value||0}
`);break;case"reset":N=w.length-1,e||(d+=`${b[a.name]} reset
`);break;case"splice":w.splice(w.indexOf(a),1),N--,e||(d+=`${b[a.name]} splice
`);break;default:throw new Error(`skill typeが不正です: ${p.type}`)}}};i&&f==="start"&&F(i,h);const K=()=>{if(w.length===0)return!1;const a=w[N];if(!a)throw new Error("メンバーが見つかりません");const m=Math.max(a.ap-M,0);return m*1e4<=y&&z<=0?(y-=m*1e4,W.set(a,(W.get(a)||0)+1),Z++,F(a,a.skills),N=w.length-1===N?0:N+1,z+=A,!0):!1};for(let a=0;a<t.length;a++){const m=t[a];if(V=t[a-1],!m)throw new Error("noteが見つかりません");for(i&&m.fever&&!V?.fever&&f==="fever_start"&&(e||(d+=`FEVER START
`),F(i,h)),!m.fever&&V?.fever&&(e||(d+=`FEVER END
`)),z-=m.time-X,X=m.time;K(););z=Math.max(0,z);for(let R=0;R<m.normalCount+m.slideCount;R++){if(o==="desperate"&&s*10>r){R<m.normalCount?s-=Math.ceil(r/15):s-=Math.ceil(r*2/75),e||(d+=`miss, apPoint: ${y}, mental: ${s}, vol_lv: ${v.lv*(m.fever?2:1)}
`);continue}B++,y+=Math.ceil(ct*q(B)*1e4),K();const j=Math.ceil(_/Y*30*G(u,v.lv,m.fever));c+=j,e||(d+=`combo: ${B}, score: ${c} (+${j}), apPoint: ${y}, mental: ${s}, vol_lv: ${v.lv*(m.fever?2:1)}
`)}}return i&&f==="end"&&F(i,h),{score:c,log:d}};var rt=`key	series	other_name	smile	pure	cool	mental	rarity	center_skill_condition	raw_center_skill_text	raw_skill_text	ap	center_ability_text
other	蓮ノ空女学院スクールアイドルクラブ102期生	大賀美沙知	5880	5700	5700	480	ur			ap_up(10);skill_count>=3 ^ splice()	0	
rurino	悠久の舞踏会		4320	7800	5160	480	ur	fever_start	ap_up(8);vol_lv >= 4 ^ ap_up(8)	vol_lv <= 8 ^ vol_buff(326.25);vol_lv >= 7 ^ score_buff(435);mental_down(10*)	10	appeal_up(g103, 200);ap_reduce(all, 2)
rurino	アイドゥーミー！		6960	6360	5880	520	ur	fever_start	ap_up(20); mental_rate <= 99 ^ vol_down(1000*)	mental_up(10*); mental_rate >= 100 ^ ap_up(15); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	5	appeal_up(miracra, 200)
megumi	久遠の銀河へ		7200	4920	4800	510	ur	fever_start	score_up(204.75); skill_count >= 6 ^ score_up(286.65)	total_skill_count <= 9 ^ ap_up(15*); total_skill_count >= 10 ^ score_up(522)	10	appeal_up(g102, 200);ap_reduce(all, 2)
kaho	アイドゥーミー！		6000	6240	6960	520	ur	end	score_up(418.5)	mental_up(10*); mental_rate >= 100 ^ score_up(1134); mental_rate <= 99 ^ vol_down(1000*)	12	appeal_up(all, 72)
sayaka	アイドゥーミー！		6120	6960	6120	520	ur	fever_start	score_up(877.5); mental_rate <= 99 ^ vol_down(1000*)	skill_count <= 1 ^ vol_buff(78.75); skill_count >= 2 ^ score_buff(243); mental_rate >= 100 ^ vol_up(945); mental_rate <= 99 ^ vol_down(1000*)	14	appeal_up(dollche, 200)
kozue	輪廻の銀河へ		5160	4680	7440	480	ur	fever_start	ap_up(8); skill_count >= 6 ^ ap_up(8)	skill_count <= 3 ^ vol_buff(324); skill_count <= 3 ^ reset(); skill_count >= 4 ^ score_buff(324)	10	appeal_up(g102, 200);ap_reduce(all, 2)
ceras	16th Birthday		5760	5760	5760	480	br	start	ap_up(10)	ap_up(5); vol_buff(54.45); reset(); skill_count >= 3 ^ splice()	0	appeal_up(ceras, 400)
tsuzuri	幸せのリボン（SLv.12以上）		5760	5160	8520	500	lr	fever_start	vol_up(478)	vol_up(731); skill_count >= 10 ^ vol_up(1170); skill_count <= 12 ^ ap_up(20*); splice()	20	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
tsuzuri	幸せのリボン（SLv.11以下）		5760	5160	8520	500	lr	fever_start	vol_up(478)	vol_up(731); skill_count >= 10 ^ vol_up(1170); splice()	20	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
sayaka	真実の舞踏会		5160	4080	7920	490	ur	fever_start	vol_up(170); mental_rate >= 50 ^ vol_up(238)	vol_lv <= 8 ^ vol_up(326); vol_lv >= 7 ^ score_buff(558); vol_lv >= 7 ^ vol_down(50*)	10	appeal_up(g103, 200); ap_reduce(all, 2)
kaho	軌跡の舞踏会		7680	5760	3960	470	ur	end	score_up(204.75); vol_lv >= 4 ^ score_up(286.65)	vol_lv <= 8 ^ score_buff(243); vol_lv >= 7 ^ score_up(522)	10	appeal_up(g103, 200); ap_reduce(all, 2)
megumi	18th Birthday*		5760	5760	5760	480	br	fever_start	score_up(368.28); total_skill_count >= 6 ^ ap_up(8)	score_buff(123.75); vol_buff(123.75); skill_count <= 4 ^ ap_up(5*); skill_count <= 2 ^ ap_up(5*)	10	appeal_up(megumi, 400)
hime	BLAST!!		3720	7080	6240	500	ur	fever_start	mental_down(40*); score_up(326.25)	mental_rate >= 30 ^ mental_down(20*); mental_rate >= 30 ^ ap_up(8*); mental_rate >= 30 ^ score_buff(74.25); mental_rate <= 30 ^ score_up(918)	20	appeal_up(miracra, 200)
ginko	輝跡の舞踏会		4320	6720	6120	490	ur	fever_start	ap_up(8); vol_lv >= 4 ^ ap_up(8)	mental_rate <= 10 ^ score_buff(253.12); mental_rate <= 10 ^ vol_buff(253.12); mental_rate <= 10 ^ ap_up(10*); mental_down(50*)	10	appeal_up(g104, 200); ap_reduce(all, 2)
rurino	17th Birthday*		5760	5760	5760	480	br	fever_start	ap_up(12); mental_rate >= 50 ^ ap_up(8)	score_buff(123.75); vol_buff(123.75); mental_rate >= 50 ^ ap_up(5*); mental_rate >= 100 ^ ap_up(5*)	10	appeal_up(rurino, 400)
ceras	十六夜セレーネ		4560	5280	7320	490	ur	fever_start	vol_up(348)	vol_lv <= 8 ^ vol_up(243); vol_lv >= 7 ^ score_buff(324); skill_count <= 2 ^ reset()	12	appeal_up(edel, 200)
ceras	天地黎明		6960	6480	3840	480	ur	end	score_up(418.5)	skill_count <= 1 ^ vol_buff(697.5); skill_count >= 2 ^ score_up(502.2); skill_count >= 3 ^ ap_up(8)	17	appeal_up(all, 80)
kozue	奇跡の舞踏会		7200	5160	4920	480	ur	fever_start	ap_up(8); total_skill_count >= 6 ^ ap_up(8)	vol_lv <= 8 ^ vol_buff(243); vol_lv >= 7 ^ score_buff(324)	8	appeal_up(g102, 200); ap_reduce(all, 2)
ginko	37.5℃のファンタジー		6720	6120	4440	480	ur	start	mental_down(25); ap_up(5)	score_buff(170.62); mental_rate >= 30 ^ reset(); mental_rate <= 25 ^ ap_up(3)	7	appeal_up(all, 80)
izumi	天地黎明		7080	6240	3960	480	ur	start	vol_up(348)	skill_count <= 1 ^ score_buff(697.5); skill_count >= 2 ^ vol_up(418); skill_count >= 3 ^ ap_up(8)	18	appeal_up(all, 80)
kosuzu	アイマイメーデー		4200	6120	6960	480	ur	fever_start	vol_up(348)	vol_up(202); mental_rate >= 30 ^ mental_down(25); mental_rate <= 25 ^ vol_up(435); mental_rate <= 25 ^ splice()	8	appeal_up(all, 80)
kozue	Prism Echo		7200	6720	6240	640	dr	start	ap_up(18)	score_buff(204.75); vol_buff(204.75); splice(); dr_ap_up()	12	appeal_up(cerise, 160); ap_reduce(all, 2); cooltime_reduce(2)
kaho	Prism Echo		7680	7200	6240	560	dr	end	score_up(502.2)	score_up(1053); splice(); dr_ap_up()	20	appeal_up(cerise, 160); ap_reduce(all, 2); cooltime_reduce(2)
sayaka	Prism Echo		6240	7680	6720	600	dr	start	vol_up(418)	vol_up(877); splice(); dr_ap_up()	20	appeal_up(dollche, 160); ap_reduce(all, 2); cooltime_reduce(2)
tsuzuri	Prism Echo		6240	6720	7680	600	dr	start	vol_up(418)	vol_up(877); splice(); dr_ap_up()	20	appeal_up(dollche, 160); ap_reduce(all, 2); cooltime_reduce(2)
rurino	Prism Echo		6720	7200	6240	640	dr	start	ap_up(12); mental_up(100)	score_buff(204.75);vol_buff(204.75);splice();dr_ap_up()	12	appeal_up(miracra, 160); ap_reduce(all, 2); cooltime_reduce(2)
megumi	Prism Echo		7680	7200	6240	560	dr	end	score_up(502.2)	score_up(1053); splice(); dr_ap_up()	20	appeal_up(miracra, 160); ap_reduce(all, 2); cooltime_reduce(2)
other	Edelied	桂城泉＆セラス 柳田 リリエンフェルト	5040	5040	5040	420	sr			score_up(631.8)	20	
kosuzu	レディバグ		4440	5520	6840	520	ur	fever_start	vol_up(170); mental_rate <= 75 ^ vol_up(204)	vol_up(478)	15	appeal_up(all, 80)`;const at=t=>t.replace(/_([a-z])/g,(l,n)=>n.toUpperCase()),S=(t=>{const l=t.split(`
`),n=l[0].split("	");return l.slice(1).map(r=>r.split("	")).map(r=>n.reduce((u,o,e)=>(u={...u,[at(o)]:r[e]===""||isNaN(Number(r[e]))?r[e]:Number(r[e])},u),{}))})(rt),nt=["<=",">="],I=Object.freeze({1:1,2:1.1,3:1.2,4:1.3,5:1.4,6:1.5,7:1.6,8:1.7,9:1.8,10:2,11:2.2,12:2.4,13:2.6,14:3}),T=Object.freeze({vol_buff:{unit:.01,fixed:2},vol_up:{unit:.01,fixed:2},vol_down:{unit:.01,fixed:2},score_up:{unit:.01,fixed:2},score_buff:{unit:.01,fixed:2},mental_up:{unit:5,fixed:0},mental_down:{unit:.01,fixed:2},ap_up:{unit:1,fixed:0},ap_down:{unit:1,fixed:0}}),E=(t,l,n)=>{const _=t.rawSkillText.replace(/([\w_]+)\(([\d.]*)(?<no_change>\*?)\)/g,(u,o,e,i)=>{if(i)return`${o}(${e})`;if(o==="dr_ap_up")return`ap_up(${(l-10)*5})`;if(!e)return`${o}()`;const f=Math.floor(Number(e)*I[l]/3/T[o].unit+1e-6)*T[o].unit;return`${o}(${f.toFixed(T[o].fixed)})`}),r=t.rawCenterSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(u,o,e,i)=>{if(i)return`${o}(${e})`;const f=Math.floor(Number(e)*I[n]/3/T[o].unit+1e-6)*T[o].unit;return`${o}(${f.toFixed(T[o].fixed)})`});return{...t,name:t.key,skill:_,centerSkillCondition:t.centerSkillCondition,centerSkill:r}};E(S[0],14,14),E(S[6],14,14),E(S[5],14,14),E(S[7],14,14),E(S[4],14,14),E(S[1],14,14);const H=t=>{if(!t)return;const l=nt.find(n=>t?.includes(n));if(l){const[n,_]=t.split(l).map(r=>r.trim());return!n||!_?void 0:[n,l,Number(_)]}else return},ut=t=>{const l=[],n=[],_=[],r=t.skill.split(";").map(u=>u.trim());for(const u of r){if(!u)continue;const[o,e]=u.split("^").map(g=>g.trim()),i=e?o:void 0,f=e||o,[,h,k]=f.match(/^(\w+)\((.*)\)$/)||[],$={type:h,value:k?Number(k):void 0,condition:H(i)};l.push($)}if(t.centerSkill){const u=t.centerSkill.split(";").map(o=>o.trim());for(const o of u){const[e,i]=o.split("^").map(A=>A.trim()),f=i?e:void 0,h=i||e,[,k,$]=h.match(/^(\w+)\((.*)\)$/)||[],g={type:k,value:$?Number($):void 0,condition:H(f)};n.push(g)}}if(t.centerAbilityText){const u=t.centerAbilityText.split(";").map(o=>o.trim());for(const o of u){const[,e,i]=o.match(/^(\w+)\((.*)\)$/)||[],f=i?i.split(",").map(k=>k.trim()):[],h={type:e,value:e==="cooltime_reduce"?{target:"all",amount:Number(f[0])}:{target:f[0]||"all",amount:Number(f[1])}};_.push(h)}}return{...t,skills:l,centerSkills:n,centerAbilities:_}},it=(t,l)=>et[l]?.includes(t)||t===l,st=(t,l,n)=>{const r=t.find(o=>o.name===n)?.centerAbilities.find(o=>o.type==="appeal_up"),u=t.reduce((o,e)=>{const i=r?it(e.name,r?.value.target):!1,f=Math.ceil(e.smile*(i?(100+(r?.value.amount||0))/100:1)),h=Math.ceil(e.pure*(i?(100+(r?.value.amount||0))/100:1)),k=Math.ceil(e.cool*(i?(100+(r?.value.amount||0))/100:1));return{smile:o.smile+f,pure:o.pure+h,cool:o.cool+k}},{smile:0,pure:0,cool:0});return u.smile=Math.round(u.smile/(l==="smile"?1:10)),u.pure=Math.round(u.pure/(l==="pure"?1:10)),u.cool=Math.round(u.cool/(l==="cool"?1:10)),u.smile+u.pure+u.cool};function*J(t,l){if(l===0)yield[];else if(l===1)for(const n of t)yield[n];else for(let n=0;n<t.length-l+1;n++){const _=t.slice(n+1);for(const r of J(_,l-1))yield[t[n],...r]}}function*Q(t){if(t.length===1)yield t;else for(let l=0;l<t.length;l++){const n=t.slice(0,l).concat(t.slice(l+1));for(const _ of Q(n))yield[t[l],..._]}}self.onmessage=t=>{const{requiredMembers:l,optionalMembers:n,notes:_,center:r,attribute:u,masteryLevel:o,playStyle:e,formationRule:i,includingCenterOnly:f,noLog:h}=t.data;let k=0;const $=6-l.length,g=new WeakMap;t:for(const A of J(n,$)){const M=[...l,...A];if(f&&!M.some(s=>s.key===r))continue;switch(i){case"current":{if(new Set(M.map(c=>c.key!=="other"?c.key:c.otherName)).size!==6)continue t;break}case"new_grand_prix":{if(M.filter(v=>v.rarity==="dr").length>1)continue t;const c={};if(M.forEach(v=>{const C=v.key!=="other"?v.key:v.otherName;c[C]=(c[C]||0)+1}),Object.values(c).some(v=>v>=3))continue t;break}}const w=M.map(s=>{if(g.has(s))return g.get(s);const c=ut(s);return g.set(s,c),c}),z=st(w,u,r),y=M.reduce((s,c)=>s+c.mental,0);for(const s of Q(w))try{const c=ot({notes:_,convertedMembers:s,center:r,appealSum:z,mentalSum:y,masteryLevel:o,playStyle:e,noLog:h});c.score>k&&(k=c.score,self.postMessage({message:"calcScore",data:{...c,members:s}}))}catch(c){console.error(c)}}self.postMessage({message:"end"})}})();
