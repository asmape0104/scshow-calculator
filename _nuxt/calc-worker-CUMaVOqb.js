(function(){"use strict";const ot=t=>t.reduce((e,l)=>e+l.normalCount+l.slideCount,0),ut=[...["kaho","sayaka","kozue","tsuzuri","rurino","megumi","ginko","kosuzu","hime","ceras","izumi"],"other"],A={kaho:"花帆",sayaka:"さやか",kozue:"梢",tsuzuri:"綴理",rurino:"瑠璃乃",megumi:"慈",ginko:"吟子",kosuzu:"小鈴",hime:"姫芽",ceras:"セラス",izumi:"泉",other:"その他"},nt={all:ut,g102:["kozue","tsuzuri","megumi"],g103:["kaho","sayaka","rurino"],g104:["ginko","kosuzu","hime"],g105:["ceras"],cerise:["kaho","kozue","ginko"],dollche:["sayaka","tsuzuri","kosuzu"],miracra:["rurino","megumi","hime"],edel:["ceras","izumi"]},it=t=>t<=2100?Math.floor((-5+Math.sqrt(25+20*t))/10):Math.floor(20+(t-2100)/200),X=(t,e,l)=>(1+t/100)*(1+e*(l?2:1)/10),K=t=>t<10?1:t<20?1.1:t<30?1.2:t<40?1.3:t<50?1.4:1.5,st=({notes:t,convertedMembers:e,center:l,appealSum:c,mentalSum:a,masteryLevel:u,playStyle:o="perfect",noLog:r=!1,noDamagedFormation:d=!1,noCuredFormation:v=!1})=>{const p=e.find(s=>s.name===l),g=p?.centerSkillCondition,x=p?.centerSkills||[],y=p?.centerAbilities||[],n=y.find(s=>s.type==="cooltime_reduce"),i=y.find(s=>s.type==="ap_reduce"),_=5-Number(n?.value.amount||0),w=Number(i?.value.amount||0),M=e.slice();let C=_,T=0,$=a,O=0;const f={_point:0,_lv:0,get point(){return this._point},set point(s){this._point=s,this._lv=it(s)},get lv(){return this._lv}},m=[0],z=[0];let R=0,et=0;const rt=ot(t);let F=0,lt=0;const J=new WeakMap,bt=60/rt;let U,k="";const q=(s,h,S)=>{const D=f.lv,gt=$*100/a;t:for(const b of h){if(b.condition){const[N,G,Q]=b.condition;let I=0;switch(N){case"skill_count":I=J.get(s)||0;break;case"total_skill_count":I=lt;break;case"vol_lv":I=D*(S?2:1);break;case"mental_rate":I=gt;break;default:throw new Error(`条件式が不正です: ${N}`)}if(Q===void 0)throw new Error(`条件式が不正です: ${N}`);switch(G){case"<=":if(!(I<=Q))continue t;break;case">=":if(!(I>=Q))continue t;break}}switch(b.type){case"vol_buff":z[0]=(z[0]||0)+(b.value||0),r||(k+=`${A[s.name]} vol_buff: +${b.value}
`);break;case"vol_up":{const N=z[0]??0;z[0]=0,f.point+=Math.ceil((b.value||0)*(1+N/100)),r||(k+=`${A[s.name]} vol_up: +${Math.ceil((b.value||0)*(1+N/100))}
`,k+=`now voltagePoint: ${f.point}
`);break}case"vol_down":f.point-=b.value||0,f.point<0&&(f.point=0),r||(k+=`${A[s.name]} vol_down: -${b.value||0}
`);break;case"score_buff":m[0]=(m[0]||0)+(b.value||0),r||(k+=`${A[s.name]} score_buff: +${b.value}
`);break;case"score_up":{const N=m[0]??0;m[0]=0;const G=(b.value||0)/100*(1+N/100)*X(u,f.lv,S);O+=Math.ceil(c*G),r||(k+=`${A[s.name]} score_up: +${Math.ceil(c*G)}
`);break}case"mental_up":$+=Math.ceil((b.value||0)/100*a),r||(k+=`${A[s.name]} mental_up: +${Math.ceil((b.value||0)/100*a)}
`);break;case"mental_down":$-=Math.ceil((b.value||0)/100*a),r||(k+=`${A[s.name]} mental_down: -${Math.ceil((b.value||0)/100*a)}
`),$<=0&&($=1);break;case"ap_up":T+=Math.ceil((b.value||0)*K(F)*1e4),r||(k+=`${A[s.name]} ap_up: +${(b.value||0)*K(F)}
`);break;case"ap_down":T-=(b.value||0)*1e4,r||(k+=`${A[s.name]} ap_down: -${b.value||0}
`);break;case"reset":R=M.length-1,r||(k+=`${A[s.name]} reset
`);break;case"splice":M.splice(M.indexOf(s),1),R--,r||(k+=`${A[s.name]} splice
`);break;default:throw new Error(`skill typeが不正です: ${b.type}`)}}};p&&g==="start"&&q(p,x,!1);const at=s=>{if(M.length===0)return!1;const h=M[R];if(!h)throw new Error("メンバーが見つかりません");const S=Math.max(h.ap-w,0);return S*1e4<=T&&C<=0?(T-=S*1e4,J.set(h,(J.get(h)||0)+1),lt++,q(h,h.skills,s),R=M.length-1===R?0:R+1,C+=_,!0):!1};for(let s=0;s<t.length;s++){const h=t[s];if(U=t[s-1],!h)throw new Error("noteが見つかりません");for(C-=h.time-et,et=h.time;at(U?.fever||!1););C=Math.max(0,C),p&&h.fever&&!U?.fever&&g==="fever_start"&&(r||(k+=`FEVER START
`),q(p,x,!0)),!h.fever&&U?.fever&&(r||(k+=`FEVER END
`));for(let S=0;S<h.normalCount+h.slideCount;S++){if(o==="desperate"&&$*10>a){S<h.normalCount?$-=Math.ceil(a/15):$-=Math.ceil(a*2/75),r||(k+=`miss, apPoint: ${T}, mental: ${$}, vol_lv: ${f.lv*(h.fever?2:1)}
`);continue}F++,T+=Math.ceil(bt*K(F)*1e4),at(h.fever);const D=Math.ceil(c/rt*30*X(u,f.lv,h.fever));if(O+=D,r||(k+=`combo: ${F}, score: ${O} (+${D}), apPoint: ${T}, mental: ${$}, vol_lv: ${f.lv*(h.fever?2:1)}
`),o==="perfect"&&d&&$<a)return r||(k+=`メンタルが100%未満になったため計算を打ち切ります
`),{score:O,log:k};if(o==="desperate"&&v&&$*10>a)return r||(k+=`メンタルが10%超になったため計算を打ち切ります
`),{score:O,log:k}}}return p&&g==="end"&&q(p,x,!1),{score:O,log:k}};var pt=`key	series	other_name	smile	pure	cool	mental	rarity	center_skill_condition	raw_center_skill_text	raw_skill_text	ap	center_ability_text
other	蓮ノ空女学院スクールアイドルクラブ102期生	大賀美沙知	5880	5700	5700	480	ur			ap_up(10);skill_count>=3 ^ splice()	0	
rurino	悠久の舞踏会		4320	7800	5160	480	ur	fever_start	ap_up(8);vol_lv >= 4 ^ ap_up(8)	vol_lv <= 8 ^ vol_buff(326.25);vol_lv >= 7 ^ score_buff(435);mental_down(10*)	10	appeal_up(g103, 200);ap_reduce(all, 2)
rurino	アイドゥーミー！		6960	6360	5880	520	ur	fever_start	ap_up(20); mental_rate <= 99 ^ vol_down(1000*)	mental_up(10*); mental_rate >= 100 ^ ap_up(15); mental_rate <= 99 ^ vol_down(1000*); skill_count >= 3 ^ splice()	5	appeal_up(miracra, 200)
megumi	久遠の銀河へ		7200	4920	4800	510	ur	fever_start	score_up(204.75); skill_count >= 6 ^ score_up(286.65)	total_skill_count <= 9 ^ ap_up(15*); total_skill_count >= 10 ^ score_up(522)	10	appeal_up(g102, 200);ap_reduce(all, 2)
kaho	アイドゥーミー！		6000	6240	6960	520	ur	end	score_up(418.5)	mental_up(10*); mental_rate >= 100 ^ score_up(1134); mental_rate <= 99 ^ vol_down(1000*)	12	appeal_up(all, 72)
sayaka	アイドゥーミー！		6120	6960	6120	520	ur	fever_start	score_up(877.5); mental_rate <= 99 ^ vol_down(1000*)	skill_count <= 1 ^ vol_buff(78.75); skill_count >= 2 ^ score_buff(243); mental_rate >= 100 ^ vol_up(945); mental_rate <= 99 ^ vol_down(1000*)	14	appeal_up(dollche, 200)
kozue	輪廻の銀河へ		5160	4680	7440	480	ur	fever_start	ap_up(8); skill_count >= 6 ^ ap_up(8)	skill_count <= 3 ^ vol_buff(324); skill_count <= 3 ^ reset(); skill_count >= 4 ^ score_buff(324)	10	appeal_up(g102, 200);ap_reduce(all, 2)
ceras	16th Birthday		5760	5760	5760	480	br	start	ap_up(10)	ap_up(5); vol_buff(54.45); reset(); skill_count >= 3 ^ splice()	0	appeal_up(ceras, 400)
tsuzuri	幸せのリボン		5760	5160	8520	500	lr	fever_start	vol_up(478)	vol_up(731); total_skill_count >= 10 ^ vol_up(1170); lr_tsuzuri(); splice()	20	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
sayaka	真実の舞踏会		5160	4080	7920	490	ur	fever_start	vol_up(170); mental_rate >= 50 ^ vol_up(238)	vol_lv <= 8 ^ vol_up(326); vol_lv >= 7 ^ score_buff(558); vol_lv >= 7 ^ vol_down(50*)	10	appeal_up(g103, 200); ap_reduce(all, 2)
kaho	軌跡の舞踏会		7680	5760	3960	470	ur	end	score_up(204.75); vol_lv >= 4 ^ score_up(286.65)	vol_lv <= 8 ^ score_buff(243); vol_lv >= 7 ^ score_up(522)	10	appeal_up(g103, 200); ap_reduce(all, 2)
megumi	18th Birthday*		5760	5760	5760	480	br	fever_start	score_up(368.28); total_skill_count >= 6 ^ ap_up(8)	score_buff(123.75); vol_buff(123.75); skill_count <= 4 ^ ap_up(5*); skill_count <= 2 ^ ap_up(5*)	10	appeal_up(megumi, 400)
hime	BLAST!!		3720	7080	6240	500	ur	fever_start	mental_down(40*); score_up(326.25)	mental_rate >= 30 ^ mental_down(20*); mental_rate >= 30 ^ ap_up(8*); mental_rate >= 30 ^ score_buff(74.25); mental_rate <= 30 ^ score_up(918)	20	appeal_up(miracra, 200)
ginko	輝跡の舞踏会		4320	6720	6120	490	ur	fever_start	ap_up(8); vol_lv >= 4 ^ ap_up(8)	mental_rate <= 10 ^ score_buff(253.12); mental_rate <= 10 ^ vol_buff(253.12); mental_rate <= 10 ^ ap_up(10*); mental_down(50*)	10	appeal_up(g104, 200); ap_reduce(all, 2)
rurino	17th Birthday*		5760	5760	5760	480	br	fever_start	ap_up(12); mental_rate >= 50 ^ ap_up(8)	score_buff(123.75); vol_buff(123.75); mental_rate >= 50 ^ ap_up(5*); mental_rate >= 100 ^ ap_up(5*)	10	appeal_up(rurino, 400)
ceras	十六夜セレーネ		4560	5280	7320	490	ur	fever_start	vol_up(348)	vol_lv <= 8 ^ vol_up(243); vol_lv >= 7 ^ score_buff(324); skill_count <= 2 ^ reset()	12	appeal_up(edel, 200)
ceras	天地黎明		6960	6480	3840	480	ur	end	score_up(418.5)	skill_count <= 1 ^ vol_buff(697.5); skill_count >= 2 ^ score_up(502.2); skill_count >= 3 ^ ap_up(8)	17	appeal_up(all, 80)
kozue	奇跡の舞踏会		7200	5160	4920	480	ur	fever_start	ap_up(8); total_skill_count >= 6 ^ ap_up(8)	vol_lv <= 8 ^ vol_buff(243); vol_lv >= 7 ^ score_buff(324)	8	appeal_up(g102, 200); ap_reduce(all, 2)
ginko	37.5℃のファンタジー		6720	6120	4440	480	ur	start	mental_down(25); ap_up(5)	score_buff(170.62); mental_rate >= 30 ^ reset(); mental_rate <= 25 ^ ap_up(3)	7	appeal_up(all, 80)
izumi	天地黎明		7080	6240	3960	480	ur	start	vol_up(348)	skill_count <= 1 ^ score_buff(697.5); skill_count >= 2 ^ vol_up(418); skill_count >= 3 ^ ap_up(8)	18	appeal_up(all, 80)
kosuzu	アイマイメーデー		4200	6120	6960	480	ur	fever_start	vol_up(348)	vol_up(202); mental_rate >= 30 ^ mental_down(25); mental_rate <= 25 ^ vol_up(435); mental_rate <= 25 ^ splice()	8	appeal_up(all, 80)
kozue	Prism Echo		7200	6720	6240	640	dr	start	ap_up(18)	score_buff(204.75); vol_buff(204.75); splice(); dr_ap_up(5)	12	appeal_up(cerise, 160); ap_reduce(all, 2); cooltime_reduce(2)
kaho	Prism Echo		7680	7200	6240	560	dr	end	score_up(502.2)	score_up(1053); splice(); dr_ap_up(5)	20	appeal_up(cerise, 160); ap_reduce(all, 2); cooltime_reduce(2)
sayaka	Prism Echo		6240	7680	6720	600	dr	start	vol_up(418)	vol_up(877); splice(); dr_ap_up(5)	20	appeal_up(dollche, 160); ap_reduce(all, 2); cooltime_reduce(2)
tsuzuri	Prism Echo		6240	6720	7680	600	dr	start	vol_up(418)	vol_up(877); splice(); dr_ap_up(5)	20	appeal_up(dollche, 160); ap_reduce(all, 2); cooltime_reduce(2)
rurino	Prism Echo		6720	7200	6240	640	dr	start	ap_up(12); mental_up(100)	score_buff(204.75);vol_buff(204.75);splice();dr_ap_up(5)	12	appeal_up(miracra, 160); ap_reduce(all, 2); cooltime_reduce(2)
megumi	Prism Echo		7680	7200	6240	560	dr	end	score_up(502.2)	score_up(1053); splice(); dr_ap_up(5)	20	appeal_up(miracra, 160); ap_reduce(all, 2); cooltime_reduce(2)
other	Edelied	桂城泉＆セラス 柳田 リリエンフェルト	5040	5040	5040	420	sr			score_up(631.8)	20	
kosuzu	レディバグ		4440	5520	6840	520	ur	fever_start	vol_up(170); mental_rate <= 75 ^ vol_up(204)	vol_up(478)	15	appeal_up(all, 80)
kaho	Ether Aria		8640	6720	5640	570	dr	end	score_up(502.2)	score_up(502.2); mental_rate >= 100 ^ score_up(1010.88); splice(); dr_ap_up(5)	20	appeal_up(cerise, 160); ap_reduce(all, 2); cooltime_reduce(2)
kozue	Ether Aria		6480	6480	8160	560	dr	start	ap_up(18)	score_buff(326.25); skill_count <= 3 ^ reset(); dr_ap_up(1)	12	appeal_up(cerise, 160); ap_reduce(all, 2); cooltime_reduce(2)
ginko	Ether Aria		5520	7800	7440	590	dr	start	mental_down(90)	mental_rate <= 1 ^ score_buff(652.5); mental_down(90*); skill_count >= 2 ^ splice(); dr_ap_up(3)	10	appeal_up(cerise, 160); ap_reduce(all, 2); cooltime_reduce(2)
sayaka	Ether Aria		6120	6240	8400	590	dr	start	vol_up(418)	vol_up(418); mental_rate <= 10 ^ vol_up(842); splice(); dr_ap_up(5)	20	appeal_up(dollche, 160); ap_reduce(all, 2); cooltime_reduce(2)
tsuzuri	Ether Aria		6240	8400	6480	560	dr	start	vol_up(418)	vol_up(418); mental_rate <= 10 ^ vol_up(842); splice(); dr_ap_up(5)	20	appeal_up(dollche, 160); ap_reduce(all, 2); cooltime_reduce(2)
kosuzu	Ether Aria		7800	7440	5760	570	dr	start	vol_up(418)	vol_up(418); mental_rate <= 10 ^ vol_up(842); splice(); dr_ap_up(5)	20	appeal_up(dollche, 160); ap_reduce(all, 2); cooltime_reduce(2)
rurino	Ether Aria		6240	8280	6480	570	dr	fever_start	ap_up(12); mental_up(100)	score_buff(204.75); mental_rate >= 100 ^ score_buff(368.55); mental_up(100); splice(); dr_ap_up(5)	12	appeal_up(miracra, 160); ap_reduce(all, 2); cooltime_reduce(2)
megumi	Ether Aria		8160	6360	6120	600	dr	end	score_up(502.2)	score_up(502.2); total_skill_count >= 15 ^ score_up(1123.2); splice(); dr_ap_up(5)	20	appeal_up(miracra, 160); ap_reduce(all, 2); cooltime_reduce(2)
hime	Ether Aria		6600	6960	7440	570	dr	end	score_up(502.2)	score_up(502.2); mental_rate <= 10 ^ score_up(1010.88); splice(); dr_ap_up(5)	20	appeal_up(miracra, 160); ap_reduce(all, 2); cooltime_reduce(2)
hime	Oracle Étude		5280	8400	7320	570	dr2	end	score_up(502.2)	score_up(502.2); mental_rate <= 1 ^ score_up(1512); mental_up(50); splice(); dr_ap_up(5)	20	appeal_up(hime, 320); ap_reduce(all, 2); cooltime_reduce(2)
rurino	Oracle Étude		6960	5400	8400	590	dr2	fever_start	ap_up(12); mental_up(100)	vol_buff(204.75); mental_rate >= 100 ^ vol_buff(368.55); mental_up(50*); reset(); splice(); dr_ap_up(5)	12	appeal_up(rurino, 320); ap_reduce(all, 2); cooltime_reduce(2)
kosuzu	Oracle Étude		7080	8640	5040	590	dr2	start	vol_up(418)	vol_up(418); mental_rate <= 1 ^ vol_up(1260); mental_rate >= 50 ^ vol_down(300*); splice(); dr_ap_up(5)	20	appeal_up(kosuzu, 320); ap_reduce(all, 2); cooltime_reduce(2)
kozue	be proud		8640	5640	5040	510	lr	start	ap_up(15)	vol_buff(112.5); reset(); lr_kozue()	5	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
megumi	やっぱ天使！		5580	8580	4800	540	lr	end	score_up(573.75)	score_up(326.25); total_skill_count >= 15 ^ score_buff(364.5); lr_megumi()	12	appeal_up(g102, 200); ap_reduce(all, 1); cooltime_reduce(2)
rurino	Very! Very! COCO夏っ		6480	6060	4500	500	ur	start	ap_up(12)	skill_count <= 2 ^ vol_buff(627.75);skill_count <= 2 ^ reset();skill_count >= 3 ^ ap_up(15)	15	appeal_up(miracra, 200)
hime	Very! Very! COCO夏っ		6600	5880	4560	500	ur	fever_start	vol_up(525)	mental_rate <= 1 ^ score_up(1755);vol_down(5000*)	20	appeal_up(miracra, 200)
kosuzu	探求の舞踏会		6840	6000	4680	460	ur	fever_start	vol_up(170);mental_rate <= 50 ^ vol_up(238)	vol_up(271);mental_rate <= 10 ^ vol_up(489);mental_up(50*)	10	appeal_up(g104, 200);ap_reduce(all, 2)
hime	邂逅の舞踏会		5760	5280	6240	480	ur	end	score_up(204.75);vol_lv >= 4 ^ score_up(286.65)	score_up(326.25);mental_rate <= 10 ^ score_up(587.25);vol_down(100*)	10	appeal_up(g104, 200);ap_reduce(all, 2)`;const ct=t=>t.replace(/_([a-z])/g,(e,l)=>l.toUpperCase()),P=(t=>{const e=t.split(`
`),l=e[0].split("	");return e.slice(1).map(a=>a.split("	")).map(a=>l.reduce((u,o,r)=>(u={...u,[ct(o)]:a[r]===""||isNaN(Number(a[r]))?a[r]:Number(a[r])},u),{}))})(pt),_t=["<=",">="],E=1e-6,Y=Object.freeze({1:1,2:1.1,3:1.2,4:1.3,5:1.4,6:1.5,7:1.6,8:1.7,9:1.8,10:2,11:2.2,12:2.4,13:2.6,14:3}),B=Object.freeze({vol_buff:{unit:.01,fixed:2},vol_up:{unit:.01,fixed:2},vol_down:{unit:.01,fixed:2},score_up:{unit:.01,fixed:2},score_buff:{unit:.01,fixed:2},mental_up:{unit:5,fixed:0},mental_down:{unit:5,fixed:0},ap_up:{unit:1,fixed:0},ap_down:{unit:1,fixed:0}}),V=Object.freeze({ur:[[1,.01],[60,.5],[80,.7],[100,1],[110,1.1],[120,1.2]],dr:[[1,.01],[100,.7],[120,1],[130,1.1],[140,1.2]],dr2:[[1,.5],[100,.7],[120,1],[130,1.1],[140,1.2]],br:[[1,.01],[80,.7],[100,1],[110,1.1],[120,1.2]],lr:[[1,.0169],[100,.7],[120,1],[130,1.1],[140,1.2]],sr:[[1,.01],[40,.5],[60,.7],[80,1],[90,1.1],[100,1.2]],r:[[1,.01],[60,1]]}),W=Object.freeze({ur:[[1,.2],[60,.5],[80,.7],[100,1],[120,1]],dr:[[1,.2],[100,.7],[120,1],[140,1]],dr2:[[1,.5],[100,.7],[120,1],[140,1]],br:[[1,.2],[80,.7],[100,1],[120,1]],lr:[[1,.205],[100,.7],[120,1],[140,1]],sr:[[1,.2],[40,.5],[60,.7],[80,1],[100,1]],r:[[1,.2],[60,1]]}),ft=Object.freeze({ur:[110,100,80,0],dr:[130,120,100,0],dr2:[130,120,100,0],br:[110,100,80,0],lr:[130,120,100,0],sr:[90,80,60,0],r:[70,60,40,0]}),dt=(t,e)=>ft[t.rarity].findIndex(l=>e>l)||0,j=(t,e,l,c=V[t.rarity][V[t.rarity].length-1][0])=>{const a=t.rawSkillText.replace(/([\w_]+)\(([\d.]*)(?<no_change>\*?)\)/g,(y,n,i,_)=>{if(_)return`${n}(${i})`;if(n==="dr_ap_up")return`ap_up(${(e-10)*Number(i)})`;if(n==="lr_tsuzuri")return"total_skill_count <= 12 ^ ap_up(20)";if(n==="lr_kozue")return"skill_count >= 10 ^ splice()";if(n==="lr_megumi")return"ap_up(2)";if(!i)return`${n}()`;const w=Math.floor(Number(i)*Y[e]/3/B[n].unit+E)*B[n].unit;return`${n}(${w.toFixed(B[n].fixed)})`}),u=t.rawCenterSkillText.replace(/([\w_]+)\(([\d.]+)(?<no_change>\*?)\)/g,(y,n,i,_)=>{if(_)return`${n}(${i})`;const w=Math.floor(Number(i)*Y[l]/3/B[n].unit+E)*B[n].unit;return`${n}(${w.toFixed(B[n].fixed)})`});let o=t.smile,r=t.pure,d=t.cool;const v=V[t.rarity];if(v){o/=v[v.length-1][1]||1,r/=v[v.length-1][1]||1,d/=v[v.length-1][1]||1;const y=v.findIndex(([i])=>i>=c),n=y-1;if(n!==-1){const[i,_]=V[t.rarity][n],[w,M]=V[t.rarity][y];o=Math.ceil(o*(_+(M-_)*(c-i)/(w-i))-E),r=Math.ceil(r*(_+(M-_)*(c-i)/(w-i))-E),d=Math.ceil(d*(_+(M-_)*(c-i)/(w-i))-E)}else{const[i,_]=V[t.rarity][y];o=Math.ceil(o*_-E),r=Math.ceil(r*_-E),d=Math.ceil(d*_-E)}}let p=t.mental;const g=W[t.rarity];if(g){p/=g[g.length-1][1]||1;const y=g.findIndex(([i])=>i>=c),n=y-1;if(n!==-1){const[i,_]=W[t.rarity][n],[w,M]=W[t.rarity][y];p=Math.ceil(p*(_+(M-_)*(c-i)/(w-i))-E)}else{const[i,_]=W[t.rarity][y];p=Math.ceil(p*_-E)}}const x=t.ap+dt(t,c);return{...t,smile:o,pure:r,cool:d,mental:p,ap:x,name:t.key,skill:a,centerSkillCondition:t.centerSkillCondition,centerSkill:u}};j(P[0],14,14),j(P[6],14,14),j(P[5],14,14),j(P[7],14,14),j(P[4],14,14),j(P[1],14,14);const Z=t=>{if(!t)return;const e=_t.find(l=>t?.includes(l));if(e){const[l,c]=t.split(e).map(a=>a.trim());return!l||!c?void 0:[l,e,Number(c)]}else return},mt=t=>{const e=[],l=[],c=[],a=t.skill.split(";").map(u=>u.trim());for(const u of a){if(!u)continue;const[o,r]=u.split("^").map(y=>y.trim()),d=r?o:void 0,v=r||o,[,p,g]=v.match(/^(\w+)\((.*)\)$/)||[],x={type:p,value:g?Number(g):void 0,condition:Z(d)};e.push(x)}if(t.centerSkill){const u=t.centerSkill.split(";").map(o=>o.trim());for(const o of u){const[r,d]=o.split("^").map(n=>n.trim()),v=d?r:void 0,p=d||r,[,g,x]=p.match(/^(\w+)\((.*)\)$/)||[],y={type:g,value:x?Number(x):void 0,condition:Z(v)};l.push(y)}}if(t.centerAbilityText){const u=t.centerAbilityText.split(";").map(o=>o.trim());for(const o of u){const[,r,d]=o.match(/^(\w+)\((.*)\)$/)||[],v=d?d.split(",").map(g=>g.trim()):[],p={type:r,value:r==="cooltime_reduce"?{target:"all",amount:Number(v[0])}:{target:v[0]||"all",amount:Number(v[1])}};c.push(p)}}return{...t,skills:e,centerSkills:l,centerAbilities:c}},vt=(t,e)=>nt[e]?.includes(t)||t===e,kt=(t,e,l)=>{const a=t.find(o=>o.name===l)?.centerAbilities.find(o=>o.type==="appeal_up"),u=t.reduce((o,r)=>{const d=a?vt(r.name,a?.value.target):!1,v=Math.ceil(r.smile*(d?(100+(a?.value.amount||0))/100:1)),p=Math.ceil(r.pure*(d?(100+(a?.value.amount||0))/100:1)),g=Math.ceil(r.cool*(d?(100+(a?.value.amount||0))/100:1));return{smile:o.smile+v,pure:o.pure+p,cool:o.cool+g}},{smile:0,pure:0,cool:0});return u.smile=Math.round(u.smile/(e==="smile"?1:10)),u.pure=Math.round(u.pure/(e==="pure"?1:10)),u.cool=Math.round(u.cool/(e==="cool"?1:10)),u.smile+u.pure+u.cool};function*L(t,e){if(e===0)yield[];else if(e===1)for(const l of t)yield[l];else for(let l=0;l<t.length-e+1;l++){const c=t.slice(l+1);for(const a of L(c,e-1))yield[t[l],...a]}}function*tt(t){if(t.length===1)yield t;else for(let e=0;e<t.length;e++){const l=t.slice(0,e).concat(t.slice(e+1));for(const c of tt(l))yield[t[e],...c]}}const H=t=>{let e=1;for(let l=1;l<=t;l++)e*=l;return e},ht=(t,e)=>H(t)/(H(e)*H(t-e));self.onmessage=t=>{const{requiredMembers:e,optionalMembers:l,notes:c,center:a,attribute:u,masteryLevel:o,playStyle:r,formationRule:d,includingCenterOnly:v,noLog:p,noDamagedFormation:g,noCuredFormation:x}=t.data;let y=0;const n=6-e.length,i=new WeakMap,_=ht(l.length,n);let w=0;t:for(const M of L(l,n)){w%100===0&&self.postMessage({message:"progress",data:{progress:w/_*100}}),w++;const C=[...e,...M];if(v&&!C.some(f=>f.key===a))continue;switch(d){case"current":{if(new Set(C.map(m=>m.key!=="other"?m.key:m.otherName)).size!==6)continue t;break}case"new_grand_prix":{if(C.filter(z=>z.rarity==="dr"||z.rarity==="dr2").length>1)continue t;const m={};if(C.forEach(z=>{const R=z.key!=="other"?z.key:z.otherName;m[R]=(m[R]||0)+1}),Object.values(m).some(z=>z>=3))continue t;break}}const T=C.map(f=>{if(i.has(f))return i.get(f);const m=mt(f);return i.set(f,m),m}),$=kt(T,u,a),O=C.reduce((f,m)=>f+m.mental,0);for(const f of tt(T))try{const m=st({notes:c,convertedMembers:f,center:a,appealSum:$,mentalSum:O,masteryLevel:o,playStyle:r,noLog:p,noDamagedFormation:g,noCuredFormation:x});m.score>y&&(y=m.score,self.postMessage({message:"calcScore",data:{...m,members:f}}))}catch(m){console.error(m)}}self.postMessage({message:"end"})}})();
